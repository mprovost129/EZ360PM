{% extends "base.html" %}
{% load humanize %}
{% block page_title %}Expenses{% endblock %}

{% block app_content %}
<div class="d-flex flex-wrap gap-2 justify-content-between align-items-end mb-3">
  <form class="row g-2 align-items-end" method="get" role="search" aria-label="Filter expenses">
    <div class="col-auto">
      <label class="form-label" for="filter-start">Start</label>
      <input id="filter-start" class="form-control" type="date" name="start" value="{{ start|date:'Y-m-d' }}">
    </div>
    <div class="col-auto">
      <label class="form-label" for="filter-end">End</label>
      <input id="filter-end" class="form-control" type="date" name="end" value="{{ end|date:'Y-m-d' }}">
    </div>
    <div class="col-auto">
      <label class="form-label" for="filter-q">Search</label>
      <input id="filter-q" class="form-control" type="search" name="q" value="{{ q }}" placeholder="Vendor, description, category…">
    </div>
    <div class="col-auto d-flex gap-2">
      <button class="btn btn-outline-secondary" type="submit">Filter</button>
      <a class="btn btn-outline-light border" href="{% url 'expenses:expenses' %}">Reset</a>
    </div>
  </form>

  <div class="d-flex gap-2">
    <a class="btn btn-primary" href="{% url 'expenses:expense_create' %}">New Expense</a>
  </div>
</div>

<div class="d-flex gap-2">
  <a class="btn btn-outline-secondary"
     href="{% url 'expenses:expenses_export_csv' %}?start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}&q={{ q|urlencode }}">
    Export CSV
  </a>
  <a class="btn btn-primary" href="{% url 'expenses:expense_create' %}">New Expense</a>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table align-middle mb-0" aria-label="Expenses">
      <thead>
        <tr>
          <th scope="col" style="width:110px">Date</th>
          <th scope="col" style="width:180px">Vendor</th>
          <th scope="col">Description</th>
          <th scope="col" style="width:140px">Category</th>
          <th scope="col" style="width:180px">Project</th>
          <th scope="col" style="width:90px" class="text-center">Billable</th>
          <th scope="col" style="width:120px" class="text-end">Amount</th>
          <th scope="col" style="width:140px" class="text-end">Invoiced</th>
          <th scope="col" style="width:160px" class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for e in expenses %}
        <tr>
          <td>{{ e.date|date:'Y-m-d' }}</td>
          <td>{{ e.vendor|default:"—" }}</td>
          <td class="text-truncate" style="max-width:520px;">{{ e.description }}</td>
          <td>{{ e.category|default:"—" }}</td>
          <td>{{ e.project|default:"—" }}</td>
          <td class="text-center">
            {% if e.is_billable %}
              <span class="badge text-bg-success">Yes</span>
            {% else %}
              <span class="badge text-bg-secondary">No</span>
            {% endif %}
          </td>
          <td class="text-end">${{ e.amount|floatformat:2|intcomma }}</td>
          <td class="text-end">
            {% if e.invoice %}
              <a class="text-decoration-none" href="{% url 'invoices:invoice_detail' e.invoice.pk %}">{{ e.invoice.number }}</a>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
          <td class="text-end">
            <div class="btn-group" role="group" aria-label="Actions for {{ e.description|default:'expense' }}">
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'expenses:expense_update' e.pk %}">Edit</a>
              <form method="post" action="{% url 'expenses:expense_delete' e.pk %}" class="d-inline">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Delete this expense?');"
                        type="submit">
                  Delete
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center text-muted py-4">No expenses in this range.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-2">
    <div class="text-muted small">
      {% if q %}Query: “<em>{{ q }}</em>”. {% endif %}
      Range: {{ start|date:'Y-m-d' }} – {{ end|date:'Y-m-d' }}.
    </div>
    <div class="d-flex gap-4">
      {% if billable_total is not None %}
        <div class="text-muted">Billable: <strong>${{ billable_total|floatformat:2|intcomma }}</strong></div>
      {% endif %}
      <div class="text-muted">Total: <strong>${{ total|floatformat:2|intcomma }}</strong></div>
    </div>
  </div>

  {# Optional pagination if your view supplies page_obj #}
  {% if page_obj %}
    <div class="card-footer d-flex justify-content-between align-items-center">
      <div class="small text-muted">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </div>
      <div class="btn-group" role="group" aria-label="Pagination">
        {% if page_obj.has_previous %}
          <a class="btn btn-sm btn-outline-secondary"
             href="?page={{ page_obj.previous_page_number }}&start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}&q={{ q|urlencode }}">Prev</a>
        {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled>Prev</button>
        {% endif %}
        {% if page_obj.has_next %}
          <a class="btn btn-sm btn-outline-secondary"
             href="?page={{ page_obj.next_page_number }}&start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}&q={{ q|urlencode }}">Next</a>
        {% else %}
          <button class="btn btn-sm btn-outline-secondary" disabled>Next</button>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
