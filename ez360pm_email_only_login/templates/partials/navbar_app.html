{% load static %}

{# App navbar (logged-in). Includes search, timer, support/help, profile menu. #}

<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom ez-topbar">
  <div class="container-fluid">
    <button id="sidebarToggleBtn" class="btn btn-outline-ez btn-sm d-lg-none me-2" type="button" aria-label="Toggle sidebar">
      <i class="bi bi-list"></i>
    </button>
    <a class="navbar-brand fw-semibold d-flex align-items-center gap-2" href="{% url 'core:app_dashboard' %}">
      <img class="ez-brand-logo" src="{% static 'images/ez360pm_logo.svg' %}" alt="EZ360PM">
    </a>

    <form class="d-none d-lg-flex" role="search" action="{% url 'core:search' %}" method="get" style="width: 420px;">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input class="form-control" name="q" value="{{ request.GET.q|default:'' }}" placeholder="Search clients, projects, documents…" aria-label="Search">
        <button class="btn btn-outline-ez" type="submit" aria-label="Search">
          <i class="bi bi-arrow-right"></i>
        </button>
      </div>
    </form>

    <div class="d-flex align-items-center gap-2">
      <button id="topbarActionsToggleBtn" class="btn btn-outline-ez btn-sm d-lg-none" type="button" aria-label="Menu">
        <i class="bi bi-three-dots-vertical"></i>
      </button>

      <div id="topbarActions">
        <!-- Timer (global per-user timer) -->
        <div class="dropdown">
          <div class="btn-group">
            <button id="timerDropdownToggle" data-fallback-dropdown="1" class="btn btn-outline-dark btn-sm dropdown-toggle" type="button" aria-expanded="false" title="Timer">
              <i class="bi bi-stopwatch me-1"></i>
              {% if timer_running and timer_state and timer_state.project %}
                <span class="me-1">{{ timer_state.project }}</span>
                <span
                  id="navbarTimerLive"
                  class="fw-semibold"
                  data-started-at="{% if timer_state.started_at %}{{ timer_state.started_at|date:'c' }}{% endif %}"
                  data-elapsed-seconds="{{ timer_total_seconds|default:0 }}"
                  data-is-paused="{% if timer_state.is_paused %}1{% else %}0{% endif %}"
                >{{ timer_elapsed|default:"0m" }}</span>
              {% elif timer_running %}
                <span
                  id="navbarTimerLive"
                  class="fw-semibold"
                  data-started-at="{% if timer_state.started_at %}{{ timer_state.started_at|date:'c' }}{% endif %}"
                  data-elapsed-seconds="{{ timer_total_seconds|default:0 }}"
                  data-is-paused="{% if timer_state.is_paused %}1{% else %}0{% endif %}"
                >{{ timer_elapsed|default:"0m" }}</span>
              {% else %}
                Timer
              {% endif %}
            </button>

            {% if timer_running and timer_state %}
              <form method="post" action="{% if timer_state.is_paused %}{% url 'timetracking:timer_resume' %}{% else %}{% url 'timetracking:timer_pause' %}{% endif %}">
                {% csrf_token %}
                <button class="btn btn-outline-dark btn-sm" type="submit" title="{% if timer_state.is_paused %}Resume{% else %}Pause{% endif %}">
                  {% if timer_state.is_paused %}
                    <i class="bi bi-play-fill"></i>
                  {% else %}
                    <i class="bi bi-pause-fill"></i>
                  {% endif %}
                </button>
              </form>
            {% endif %}
          </div>
          <div id="timerDropdownMenu" class="dropdown-menu dropdown-menu-end p-3" style="min-width: 320px;">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-semibold">Time tracker</div>
              {% if timer_running %}
                <span class="badge text-bg-success">Running</span>
              {% else %}
                <span class="badge text-bg-secondary">Stopped</span>
              {% endif %}
            </div>

            {% if timer_running and timer_state %}
              <div class="text-secondary small mb-2">
                {% if timer_state.is_paused %}Paused{% else %}Started{% endif %}: {{ timer_state.started_at|default:timer_state.paused_at }}
              </div>
              <form method="post" action="{% url 'timetracking:timer_stop' %}">
                {% csrf_token %}
                <button class="btn btn-danger w-100" type="submit">
                  <i class="bi bi-stop-circle me-1"></i>Stop (creates a draft entry)
                </button>
              </form>
            {% else %}
              {% if timer_form %}
                <form method="post" action="{% url 'timetracking:timer_start' %}">
                  {% csrf_token %}
                  <div class="mb-2">
                    <label class="form-label small">Project</label>
                    {{ timer_form.project }}
                    {% if timer_state and timer_state.project_id %}
                      <div class="mt-1">
                        <a class="small" href="{% url 'projects:project_detail' timer_state.project_id %}"><i class="bi bi-box-arrow-up-right me-1"></i>Open selected project</a>
                      </div>
                    {% endif %}
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Service (optional)</label>
                    {{ timer_form.service_catalog_item }}
                    <div class="mt-2">{{ timer_form.service_name }}</div>
                    {% if timer_form.save_service_to_catalog %}
                      <div class="form-check mt-2">
                        {{ timer_form.save_service_to_catalog }}
                        <label class="form-check-label small" for="{{ timer_form.save_service_to_catalog.id_for_label }}">Save as catalog service</label>
                      </div>
                    {% endif %}
                    {% if can_manage_catalog %}
                      <div class="mt-2">
                        <a class="small" href="{% url 'catalog:item_list' %}"><i class="bi bi-tags me-1"></i>Manage catalog services</a>
                      </div>
                    {% endif %}
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Notes (optional)</label>
                    {{ timer_form.note }}
                  </div>
                  <button class="btn btn-ez w-100" type="submit">
                    <i class="bi bi-play-circle me-1"></i>Start timer
                  </button>
                </form>
                {% if timer_state and not timer_running %}
                  {% if timer_state.project_id or timer_state.service_catalog_item_id or timer_state.service_name or timer_state.note %}
                    <form method="post" action="{% url 'timetracking:timer_clear' %}" class="mt-2">
                      {% csrf_token %}
                      <button class="btn btn-outline-secondary w-100" type="submit"><i class="bi bi-x-circle me-1"></i>Clear selections</button>
                    </form>
                    <div class="text-secondary small mt-2">Your last selections are remembered after stopping.</div>
                  {% endif %}
                {% endif %}
              {% else %}
                <div class="text-secondary small">{{ timer_unavailable_reason|default:'Timer unavailable.' }}</div>
              {% endif %}
            {% endif %}

            <hr class="my-2">
            <a class="btn btn-outline-secondary btn-sm w-100" href="{% url 'timetracking:timer_panel' %}">
              Open timer page
            </a>
          </div>
        </div>

        <script>
          (function () {
            const el = document.getElementById('navbarTimerLive');
            if (!el) return;

            const startedAtRaw = el.getAttribute('data-started-at') || '';
            let elapsedSeconds = parseInt(el.getAttribute('data-elapsed-seconds') || '0', 10) || 0;
            const isPaused = (el.getAttribute('data-is-paused') || '0') === '1';
            const startedAt = startedAtRaw ? new Date(startedAtRaw) : null;

            function fmt(sec) {
              sec = Math.max(0, sec|0);
              const hrs = Math.floor(sec / 3600);
              const mins = Math.floor((sec % 3600) / 60);
              const remS = sec % 60;
              if (hrs > 0) return `${hrs}:${String(mins).padStart(2,'0')}:${String(remS).padStart(2,'0')}`;
              return `${mins}:${String(remS).padStart(2,'0')}`;
            }

            function tick() {
              if (isPaused) {
                el.textContent = fmt(elapsedSeconds);
                return;
              }
              if (!startedAt) {
                el.textContent = fmt(elapsedSeconds);
                return;
              }
              const now = new Date();
              const delta = Math.floor((now.getTime() - startedAt.getTime()) / 1000);
              el.textContent = fmt(elapsedSeconds + Math.max(0, delta));
            }

            tick();
            setInterval(tick, 1000);
          })();
        </script>

        <!-- Notifications placeholder -->
        <a class="btn btn-outline-dark btn-sm" href="#" title="Notifications (coming soon)">
          <i class="bi bi-bell"></i>
        </a>

        <!-- Support menu (staff tools + Help Center) -->
        <div class="dropdown">
          <button class="btn btn-outline-dark btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Help & Support">
            <i class="bi bi-question-circle"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{% url 'helpcenter:home' %}"><i class="bi bi-life-preserver me-1"></i>Help Center</a></li>
            <li><hr class="dropdown-divider"></li>
            {% if is_staff %}
              <li><h6 class="dropdown-header">Staff</h6></li>
              <li><a class="dropdown-item" href="{% url 'ops:settings_home' %}"><i class="bi bi-sliders me-1"></i>Ops settings</a></li>
              <li><a class="dropdown-item" href="{% url 'billing:webhook_history' %}"><i class="bi bi-lightning-charge me-1"></i>Webhook logs</a></li>
              <li><a class="dropdown-item" href="{% url 'core:support_mode_status' %}"><i class="bi bi-headset me-1"></i>Support mode</a></li>
            {% endif %}
          </ul>
        </div>

        <button id="themeToggleBtn" class="btn btn-outline-ez btn-sm" type="button" title="Light/Dark">
          <i class="bi bi-moon-stars"></i>
        </button>

        <!-- User dropdown -->

        {% if request.user.is_staff %}
                  <div class="dropdown">
                    <button class="btn btn-outline-danger btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Support & staff tools">
                      <i class="bi bi-shield-lock"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li><a class="dropdown-item" href="{% url 'core:support_mode_status' %}"><i class="bi bi-headset me-2"></i>Support Mode</a></li>
                      {% if qa_report_href %}
                        <li><a class="dropdown-item" href="{{ qa_report_href }}"><i class="bi bi-bug me-2"></i>Report QA issue</a></li>
                      {% endif %}
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="{% url 'ops:dashboard' %}"><i class="bi bi-shield-lock me-2"></i>Ops Console</a></li>
                      <li><a class="dropdown-item" href="{% url 'ops:launch_checks' %}"><i class="bi bi-clipboard-check me-2"></i>Launch Checks</a></li>
                      <li><a class="dropdown-item" href="{% url 'ops:email_test' %}"><i class="bi bi-envelope-at me-2"></i>Email Test</a></li>
                      <li><a class="dropdown-item" href="{% url 'ops:retention' %}"><i class="bi bi-trash3 me-2"></i>Retention</a></li>
                    </ul>
                  </div>
                  {% endif %}

        <div class="dropdown">
          <button class="btn btn-outline-dark btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Account">
            <i class="bi bi-person-circle me-1"></i>
            {% if request.user.first_name or request.user.last_name %}
              {{ request.user.first_name }} {{ request.user.last_name }}
            {% else %}
              {{ request.user.email }}
            {% endif %}
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{% url 'accounts:profile' %}">Profile</a></li>
            <li><a class="dropdown-item" href="{% url 'billing:overview' %}">Billing</a></li>
            <li><a class="dropdown-item" href="#">Refer a friend (coming soon)</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{% url 'accounts:logout' %}">Log out</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</nav>

{% if support_mode and support_mode.is_active %}
  <div class="bg-warning-subtle border-bottom">
    <div class="container-fluid py-2 small d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div>
        <span class="fw-semibold">Support Mode Active</span>
        {% if active_company %} — {{ active_company.name }}{% endif %}
        {% if support_mode.expires_at %} (expires {{ support_mode.expires_at|date:"H:i" }}){% endif %}
      </div>
      <div class="d-flex gap-2 align-items-center">
        <a class="btn btn-sm btn-outline-dark" href="{% url 'core:support_mode_status' %}">Status</a>
        <form method="post" action="{% url 'core:support_mode_exit' %}">
          {% csrf_token %}
          <button class="btn btn-sm btn-outline-danger" type="submit">Exit</button>
        </form>
      </div>
    </div>
  </div>
{% endif %}