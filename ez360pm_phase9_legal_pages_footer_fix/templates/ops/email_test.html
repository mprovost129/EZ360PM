{% extends "base_app.html" %}
{% load static %}
{% block title %}Email test · Ops · EZ360PM{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 980px;">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1">Email test</h1>
      <div class="text-secondary small">Send a test email to validate production email configuration.</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-dark" href="{% url 'ops:dashboard' %}">Back</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:alerts' %}">Alerts</a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="fw-semibold mb-2">Send test email</div>
          <form method="post" class="vstack gap-2">
            {% csrf_token %}
            <div>
              <label class="form-label">To</label>
              {{ form.to_email }}
              {% if form.to_email.errors %}<div class="text-danger small">{{ form.to_email.errors }}</div>{% endif %}
            </div>
            <div>
              <label class="form-label">Subject</label>
              {{ form.subject }}
            </div>
            <div>
              <label class="form-label">Message</label>
              {{ form.message }}
            </div>
            <div class="d-flex align-items-center justify-content-between">
              <div class="text-secondary small">Uses current EMAIL_BACKEND and DEFAULT_FROM_EMAIL.</div>
              <button class="btn btn-dark" type="submit">Send</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="fw-semibold mb-2">Config snapshot</div>
          <div class="small">
            <div><span class="text-secondary">EMAIL_BACKEND:</span> {{ diag.email_backend }}</div>
            <div><span class="text-secondary">DEFAULT_FROM_EMAIL:</span> {{ diag.default_from_email }}</div>
            <div><span class="text-secondary">SERVER_EMAIL:</span> {{ diag.server_email }}</div>
            <hr class="my-2">
            <div><span class="text-secondary">EMAIL_HOST:</span> {{ diag.email_host }}</div>
            <div><span class="text-secondary">EMAIL_PORT:</span> {{ diag.email_port }}</div>
            <div><span class="text-secondary">EMAIL_USE_TLS:</span> {{ diag.email_use_tls }}</div>
            <div><span class="text-secondary">EMAIL_USE_SSL:</span> {{ diag.email_use_ssl }}</div>
            <div><span class="text-secondary">EMAIL_TIMEOUT:</span> {{ diag.email_timeout }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="fw-semibold mb-2">Recent tests</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>When</th>
                  <th>Status</th>
                  <th>To</th>
                  <th class="text-end">ms</th>
                </tr>
              </thead>
              <tbody>
                {% for t in recent %}
                  <tr>
                    <td class="text-secondary small">{{ t.created_at|date:"Y-m-d H:i" }}</td>
                    <td>
                      {% if t.status == 'sent' %}
                        <span class="badge text-bg-success">Sent</span>
                      {% else %}
                        <span class="badge text-bg-danger">Failed</span>
                      {% endif %}
                    </td>
                    <td class="small">{{ t.to_email }}</td>
                    <td class="text-end small">{{ t.latency_ms }}</td>
                  </tr>
                  {% if t.error %}
                    <tr>
                      <td colspan="4" class="small text-danger">{{ t.error }}</td>
                    </tr>
                  {% endif %}
                {% empty %}
                  <tr>
                    <td colspan="4" class="text-secondary small">No email tests recorded yet.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
