{% extends "base_app.html" %}
{% load static %}

{% block title %}{% if mode == 'edit' %}Edit client{% else %}New client{% endif %} · EZ360PM{% endblock %}

{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">
      {% if mode == 'edit' %}Edit client{% else %}New client{% endif %}
    </h1>
    <div class="text-secondary small">Add or update client contact information.</div>
  </div>
  <div>
    <a class="btn btn-outline-secondary" href="{% url 'crm:client_list' %}"><i class="bi bi-arrow-left me-1"></i>Back to clients</a>
  </div>
</div>

<form method="post" novalidate class="ez-form">
  {% csrf_token %}

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}

      <div class="row g-3">
        <div class="col-12 col-md-4">
          <label class="form-label">First name</label>
          {{ form.first_name }}
          {% for e in form.first_name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Last name</label>
          {{ form.last_name }}
          {% for e in form.last_name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Company name</label>
          {{ form.company_name }}
          {% for e in form.company_name.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Email</label>
          {{ form.email }}
          {% for e in form.email.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-12">
          <label class="form-label">Internal note</label>
          {{ form.internal_note }}
          {% for e in form.internal_note.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Address 1</label>
          {{ form.address1 }}
          {% for e in form.address1.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Address 2</label>
          {{ form.address2 }}
          {% for e in form.address2.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">City</label>
          {{ form.city }}
          {% for e in form.city.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">State</label>
          {{ form.state }}
          {% for e in form.state.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Zip</label>
          {{ form.zip_code }}
          {% for e in form.zip_code.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-header bg-white">
      <div class="d-flex align-items-center justify-content-between">
        <div class="fw-semibold">Phone numbers</div>
        <div class="text-secondary small">Add multiple numbers if needed.</div>
      </div>
    </div>
    <div class="card-body">
      {{ formset.management_form }}

      {% if formset.non_form_errors %}
        <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
      {% endif %}

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 180px;">Type</th>
              <th>Number</th>
              <th style="width: 80px;" class="text-center">Remove</th>
            </tr>
          </thead>
          <tbody>
            {% for f in formset.forms %}
              <tr>
                <td>
                  {{ f.phone_type }}
                  {% for e in f.phone_type.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                </td>
                <td>
                  {{ f.number }}
                  {% for e in f.number.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                </td>
                <td class="text-center">
                  {% if f.instance.pk %}
                    {{ f.DELETE }}
                  {% else %}
                    <span class="text-secondary">—</span>
                  {% endif %}
                  {{ f.id }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="text-secondary small">
        Tip: To add more rows, save once — the formset will expand.
      </div>
    </div>
  </div>

  {% url 'crm:client_list' as cancel_url %}
  {% include "partials/form_footer.html" with cancel_url=cancel_url primary_label="Save" %}
</form>
{% endblock %}
