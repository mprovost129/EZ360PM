{% extends "base.html" %}
{% load humanize tz %}
{% block page_title %}Add Payment — {{ inv.number }}{% endblock %}

{% block app_content %}
<div class="row g-3">
  <div class="col-lg-7">
    <form method="post" novalidate id="payment-form">
      {% csrf_token %}
      <div class="card shadow-sm">
        <div class="card-body">
          {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
          {% endif %}

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="{{ form.amount.id_for_label }}">Amount</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                {{ form.amount }}
                <span class="input-group-text">{{ inv.currency|upper|default:"USD" }}</span>
              </div>
              {% if form.amount.errors %}
                <div class="text-danger small mt-1">{{ form.amount.errors }}</div>
              {% endif %}
              <div class="form-text" id="amountHelp">
                Balance: <strong>${{ inv.balance|floatformat:2|intcomma }}</strong>.
                <a href="#" id="use-balance" data-balance="{{ inv.balance|floatformat:2 }}">Use full balance</a>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="{{ form.received_at.id_for_label }}">Received at</label>
              <div class="d-flex gap-2">
                {{ form.received_at }}
                <button class="btn btn-outline-secondary btn-sm" type="button" id="use-now">
                  Use current time
                </button>
              </div>
              {% if form.received_at.errors %}
                <div class="text-danger small mt-1">{{ form.received_at.errors }}</div>
              {% endif %}
              <div class="form-text">Local time</div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="{{ form.method.id_for_label }}">Method</label>
              {{ form.method }}
              {% if form.method.errors %}
                <div class="text-danger small mt-1">{{ form.method.errors }}</div>
              {% endif %}
              <div class="form-text" id="methodHelp">e.g., Stripe, ACH, Cash, Check</div>
            </div>
          </div>
        </div>

        <div class="card-footer d-flex justify-content-between">
          <a class="btn btn-outline-secondary" href="{% url 'invoices:invoice_detail' inv.pk %}">Cancel</a>
          <button class="btn btn-primary" type="submit" id="save-btn">Save</button>
        </div>
      </div>
    </form>
  </div>

  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="fw-semibold mb-2">Invoice Summary</div>

        <div class="d-flex justify-content-between">
          <span class="text-muted">Invoice #</span><span class="fw-semibold">{{ inv.number }}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span class="text-muted">Client</span><span>{{ inv.client }}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span class="text-muted">Project</span><span>{{ inv.project|default:"—" }}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span class="text-muted">Issued</span><span>{{ inv.issue_date|date:"Y-m-d" }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span class="text-muted">Due</span><span>{{ inv.due_date|date:"Y-m-d"|default:"—" }}</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between">
          <span class="text-muted">Subtotal</span><span>${{ inv.subtotal|floatformat:2|intcomma }}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span class="text-muted">Tax</span><span>${{ inv.tax|floatformat:2|intcomma }}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span class="fw-semibold">Total</span><span class="fw-semibold">${{ inv.total|floatformat:2|intcomma }}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span class="text-muted">Paid</span><span>${{ inv.amount_paid|floatformat:2|intcomma }}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span class="fw-semibold">Balance</span><span class="fw-bold">${{ inv.balance|floatformat:2|intcomma }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  // Fill amount with full balance
  const balLink = document.getElementById('use-balance');
  if (balLink) {
    balLink.addEventListener('click', function (e) {
      e.preventDefault();
      const amountInput = document.getElementById('{{ form.amount.id_for_label }}');
      const val = this.getAttribute('data-balance');
      if (amountInput && val) {
        amountInput.value = val;
        amountInput.focus();
      }
    });
  }

  // Quick "Use current time" for datetime-local
  function pad(n){return n<10?'0'+n:n}
  const nowBtn = document.getElementById('use-now');
  if (nowBtn) {
    nowBtn.addEventListener('click', function () {
      const dt = document.getElementById('{{ form.received_at.id_for_label }}');
      if (!dt) return;
      const d = new Date();
      const local = d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) +
                    'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
      dt.value = local;
      dt.focus();
    });
  }

  // Prevent accidental double-submit
  const form = document.getElementById('payment-form');
  const saveBtn = document.getElementById('save-btn');
  if (form && saveBtn) {
    form.addEventListener('submit', function() {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving…';
    });
  }
})();
</script>
{% endblock %}
