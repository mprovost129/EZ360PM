{% extends "base.html" %}
{% load humanize %}

{% block page_title %}Estimates{% endblock %}

{% block app_content %}
<div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
  <!-- Search form -->
  <form class="d-flex" method="get" role="search" aria-label="Search estimates" style="max-width:520px; width:100%">
    <input 
      type="search" 
      name="q" 
      value="{{ q }}" 
      class="form-control" 
      placeholder="Search by number, client, project…"
      aria-label="Search by number, client, or project"
    >
    {% if show_templates %}
      <input type="hidden" name="templates" value="1">
    {% endif %}
  </form>

  <!-- Toggle + new button -->
  <div class="d-flex gap-2">
    {% if show_templates %}
      <a class="btn btn-outline-secondary" href="{% url 'estimates:estimates_list' %}">All Estimates</a>
    {% else %}
      <a class="btn btn-outline-secondary" href="{% url 'estimates:estimates_list' %}?templates=1">Templates</a>
    {% endif %}
    <a class="btn btn-primary" href="{% url 'estimates:estimate_create' %}">New Estimate</a>
  </div>
</div>

<!-- Estimates table -->
<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table align-middle mb-0" aria-label="Estimates list">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Client</th>
          <th scope="col">Project</th>
          <th scope="col">Status</th>
          <th scope="col">Issued</th>
          <th scope="col">Valid Until</th>
          <th scope="col" class="text-end">Total</th>
          <th scope="col" class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for e in estimates %}
        <tr>
          <!-- Number -->
          <td>
            <a href="{% url 'estimates:estimate_detail' e.pk %}">{{ e.number }}</a>
            {% if e.is_template %}
              <span class="badge bg-secondary ms-1">Template</span>
            {% endif %}
          </td>

          <!-- Client / Project -->
          <td>{{ e.client }}</td>
          <td>{{ e.project|default:"—" }}</td>

          <!-- Status -->
          <td>
            {% if e.status == 'accepted' %}
              <span class="badge text-bg-success text-capitalize">{{ e.status }}</span>
            {% elif e.status == 'declined' %}
              <span class="badge text-bg-danger text-capitalize">{{ e.status }}</span>
            {% elif e.status == 'sent' %}
              <span class="badge text-bg-primary text-capitalize">{{ e.status }}</span>
            {% elif e.status == 'expired' %}
              <span class="badge text-bg-warning text-capitalize">{{ e.status }}</span>
            {% else %}
              <span class="badge text-bg-secondary text-capitalize">{{ e.status }}</span>
            {% endif %}
          </td>

          <!-- Dates -->
          <td>{{ e.issue_date|date:"Y-m-d" }}</td>
          <td>{{ e.valid_until|date:"Y-m-d"|default:"—" }}</td>

          <!-- Total -->
          <td class="text-end">
            ${{ e.total|floatformat:2|intcomma }}
          </td>

          <!-- Actions -->
          <td class="text-end">
            {% if e.is_template %}
              <a class="btn btn-sm btn-outline-primary" href="{% url 'estimates:estimate_create_from' e.pk %}">Use Template</a>
            {% else %}
              <div class="btn-group" role="group" aria-label="Actions for {{ e.number }}">
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'estimates:estimate_update' e.pk %}">Edit</a>
                <form method="post" action="{% url 'estimates:estimate_delete' e.pk %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete estimate {{ e.number }}?')">
                    Delete
                  </button>
                </form>
              </div>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center text-muted py-4">
            {% if show_templates %}
              No templates yet.
            {% else %}
              No estimates yet.
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
