{% extends "base_app.html" %}
{% block title %}Audit Log · EZ360PM{% endblock %}

{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">Audit log</h1>
    <div class="text-secondary small">Track key activity across your company (documents, approvals, exports, billing, and more).</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-dark" href="{% url 'audit:event_export_csv' %}?q={{ q|urlencode }}&event_type={{ event_type|urlencode }}&object_type={{ object_type|urlencode }}&actor={{ actor|urlencode }}&from={{ date_from|urlencode }}&to={{ date_to|urlencode }}">
      <i class="bi bi-download me-1"></i>Export CSV
    </a>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-12 col-lg-4">
        <label class="form-label small text-secondary">Search</label>
        <input class="form-control" name="q" value="{{ q }}" placeholder="invoice.sent, time.approved, summary text, actor...">
      </div>
      <div class="col-6 col-lg-2">
        <label class="form-label small text-secondary">Event type</label>
        <input class="form-control" name="event_type" value="{{ event_type }}" placeholder="invoice.">
      </div>
      <div class="col-6 col-lg-2">
        <label class="form-label small text-secondary">Object type</label>
        <input class="form-control" name="object_type" value="{{ object_type }}" placeholder="Invoice">
      </div>
      <div class="col-6 col-lg-2">
        <label class="form-label small text-secondary">Actor</label>
        <input class="form-control" name="actor" value="{{ actor }}" placeholder="mike">
      </div>
      <div class="col-6 col-lg-1">
        <label class="form-label small text-secondary">From</label>
        <input class="form-control" type="date" name="from" value="{{ date_from }}">
      </div>
      <div class="col-6 col-lg-1">
        <label class="form-label small text-secondary">To</label>
        <input class="form-control" type="date" name="to" value="{{ date_to }}">
      </div>
      <div class="col-12 d-flex gap-2 mt-2">
        <button class="btn btn-dark" type="submit"><i class="bi bi-funnel me-1"></i>Filter</button>
        <a class="btn btn-outline-secondary" href="{% url 'audit:event_list' %}">Reset</a>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th style="width: 170px;">When</th>
            <th style="width: 220px;">Event</th>
            <th style="width: 180px;">Object</th>
            <th>Summary</th>
            <th style="width: 160px;">Actor</th>
          </tr>
        </thead>
        <tbody>
          {% for ev in page_obj %}
            <tr>
              <td class="text-secondary small">{{ ev.created_at|date:"Y-m-d H:i" }}</td>
              <td class="fw-semibold">
                <a href="{% url 'audit:event_detail' ev.id %}" class="text-decoration-none">{{ ev.event_type }}</a>
              </td>
              <td class="text-secondary">
                <div class="small">{{ ev.object_type }}</div>
                <div class="small text-muted">{{ ev.object_id }}</div>
              </td>
              <td>{{ ev.summary }}</td>
              <td class="text-secondary">
                {% if ev.actor %}
                  {{ ev.actor.display_name|default:ev.actor.username_public }}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="5" class="p-4 text-center text-secondary">No audit events found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if page_obj.paginator.num_pages > 1 %}
  <nav class="mt-3" aria-label="Audit pagination">
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}&event_type={{ event_type|urlencode }}&object_type={{ object_type|urlencode }}&actor={{ actor|urlencode }}&from={{ date_from|urlencode }}&to={{ date_to|urlencode }}">Previous</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}&event_type={{ event_type|urlencode }}&object_type={{ object_type|urlencode }}&actor={{ actor|urlencode }}&from={{ date_from|urlencode }}&to={{ date_to|urlencode }}">Next</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
{% endif %}
{% endblock %}
