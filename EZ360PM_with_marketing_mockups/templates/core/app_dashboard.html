{% extends "base_app.html" %}
{% load static %}

{% block title %}Dashboard · EZ360PM{% endblock %}

{% block content %}
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <div class="text-secondary small mb-1">
        <span class="fw-semibold">{{ user_display_name }}</span>
        <span class="mx-1">·</span>
        <span>{{ user_role_label }}</span>
      </div>
      <h1 class="ez-page-title mb-0">Dashboard</h1>
    </div>
    <div class="d-flex gap-2">
      {% if can_customize_dashboard %}
        <a class="btn btn-outline-ez" href="{% url 'core:dashboard_customize' %}">
          <i class="bi bi-sliders me-1"></i>Customize
        </a>
      {% endif %}
      <a class="btn btn-outline-ez" href="{% url 'helpcenter:getting_started' %}">
        <i class="bi bi-question-circle me-1"></i>Help
      </a>
      <a class="btn btn-outline-ez" href="{% url 'companies:settings' %}">
        <i class="bi bi-gear me-1"></i>Company settings
      </a>
    </div>
  </div>

  {# Render widgets based on the resolved layout #}
  <div class="row g-3">
    <div class="col-lg-7">
      <div class="d-flex flex-column gap-3">
        {% for key in dashboard_layout.left %}
          {% with tpl="core/dashboard_widgets/"|add:key|add:".html" %}
            {% include tpl %}
          {% endwith %}
        {% endfor %}
      </div>
    </div>

    <div class="col-lg-5">
      <div class="d-flex flex-column gap-3">
        {% for key in dashboard_layout.right %}
          {% with tpl="core/dashboard_widgets/"|add:key|add:".html" %}
            {% include tpl %}
          {% endwith %}
        {% endfor %}
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    (function () {
      function getCssVar(name, fallback) {
        try {
          var v = getComputedStyle(document.documentElement).getPropertyValue(name);
          if (!v) return fallback;
          return v.trim() || fallback;
        } catch (e) {
          return fallback;
        }
      }

      var EZ_PRIMARY = getCssVar('--ez-primary', '#1F4DA0');
      var EZ_ACCENT = getCssVar('--ez-accent', '#43B97F');
      var GRID = getCssVar('--ez-border', '#E5EAF1');

      var moneyFmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
      function centsToMoney(cents) {
        var v = Number(cents || 0) / 100.0;
        return moneyFmt.format(v);
      }

      async function fetchSeries(url) {
        var res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('Failed to load chart data');
        return await res.json();
      }

      async function initRevenueTrend() {
        var el = document.getElementById('ezRevenueTrendChart');
        if (!el) return;
        var url = el.getAttribute('data-url');
        if (!url) return;

        var payload = await fetchSeries(url);

        new Chart(el, {
          type: 'line',
          data: {
            labels: payload.labels || [],
            datasets: [{
              label: 'Revenue',
              data: payload.series || [],
              borderColor: EZ_PRIMARY,
              backgroundColor: 'rgba(31, 77, 160, 0.08)',
              fill: true,
              tension: 0.25,
              pointRadius: 3,
              pointHoverRadius: 5,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (ctx) { return centsToMoney(ctx.parsed.y); }
                }
              }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: '#64748B' },
              },
              y: {
                grid: { color: GRID },
                ticks: {
                  color: '#64748B',
                  callback: function (val) { return centsToMoney(val); }
                }
              }
            }
          }
        });
      }

      async function initArAging() {
        var el = document.getElementById('ezArAgingChart');
        if (!el) return;
        var url = el.getAttribute('data-url');
        if (!url) return;

        var payload = await fetchSeries(url);

        new Chart(el, {
          type: 'bar',
          data: {
            labels: payload.labels || [],
            datasets: [{
              label: 'A/R',
              data: payload.series || [],
              backgroundColor: EZ_ACCENT,
              borderRadius: 8,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (ctx) { return centsToMoney(ctx.parsed.y); }
                }
              }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: '#64748B' },
              },
              y: {
                grid: { color: GRID },
                ticks: {
                  color: '#64748B',
                  callback: function (val) { return centsToMoney(val); }
                }
              }
            }
          }
        });
      }

      document.addEventListener('DOMContentLoaded', function () {
        // Charts are additive: if endpoints fail, we don't break the dashboard.
        initRevenueTrend().catch(function () {});
        initArAging().catch(function () {});
      });
    })();
  </script>
{% endblock %}
