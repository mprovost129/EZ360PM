{% extends "base.html" %}
{% block page_title %}Refer a Friend{% endblock %}

{% block app_content %}
<div class="card shadow-sm">
  <div class="card-body">
    <p>Share this link with a friend. When they sign up, you’ll both get a credit.</p>

    <label for="ref-link" class="form-label visually-hidden">Referral link</label>
    <div class="input-group">
      <input id="ref-link" class="form-control text-truncate" value="{{ link }}" readonly>
      <button id="copyBtn" class="btn btn-outline-secondary" type="button">Copy</button>
    </div>
    <div id="copyMsg" class="form-text small mt-1" style="display:none;"></div>

    {# Share buttons #}
    {% with enc_link=link|urlencode enc_text="Check out EZ360PM — manage projects, invoices & time in one place."|urlencode enc_subject="Join me on EZ360PM"|urlencode %}
      <div class="mt-3 d-flex flex-wrap gap-2">
        <button id="nativeShare" class="btn btn-primary" type="button">
          <i class="bi bi-share me-1" aria-hidden="true"></i> Share
        </button>

        <a class="btn btn-outline-primary"
           href="mailto:?subject={{ enc_subject }}&body={{ enc_text }}%0A%0A{{ enc_link }}">
          <i class="bi bi-envelope me-1" aria-hidden="true"></i> Email
        </a>

        <a class="btn btn-outline-dark"
           href="https://twitter.com/intent/tweet?text={{ enc_text }}&url={{ enc_link }}"
           target="_blank" rel="noopener noreferrer">
          <i class="bi bi-twitter-x me-1" aria-hidden="true"></i> X
        </a>

        <a class="btn btn-outline-primary"
           href="https://www.facebook.com/sharer/sharer.php?u={{ enc_link }}"
           target="_blank" rel="noopener noreferrer">
          <i class="bi bi-facebook me-1" aria-hidden="true"></i> Facebook
        </a>

        <a class="btn btn-outline-primary"
           href="https://www.linkedin.com/sharing/share-offsite/?url={{ enc_link }}"
           target="_blank" rel="noopener noreferrer">
          <i class="bi bi-linkedin me-1" aria-hidden="true"></i> LinkedIn
        </a>

        <a class="btn btn-outline-success"
           href="https://api.whatsapp.com/send?text={{ enc_text }}%20{{ enc_link }}"
           target="_blank" rel="noopener noreferrer">
          <i class="bi bi-whatsapp me-1" aria-hidden="true"></i> WhatsApp
        </a>

        <a class="btn btn-outline-info"
           href="https://t.me/share/url?url={{ enc_link }}&text={{ enc_text }}"
           target="_blank" rel="noopener noreferrer">
          <i class="bi bi-telegram me-1" aria-hidden="true"></i> Telegram
        </a>
      </div>
    {% endwith %}

    <p class="text-muted small mt-3 mb-0">
      Add real rewards logic later (coupons, credits, etc.).
    </p>
  </div>
</div>

<script>
  (function () {
    const btn = document.getElementById('copyBtn');
    const input = document.getElementById('ref-link');
    const msg = document.getElementById('copyMsg');
    const shareBtn = document.getElementById('nativeShare');

    function showMsg(text, ok=true) {
      if (!msg) return;
      msg.textContent = text;
      msg.style.display = 'block';
      msg.classList.remove('text-danger','text-success');
      msg.classList.add(ok ? 'text-success' : 'text-danger');
      clearTimeout(msg._t);
      msg._t = setTimeout(() => { msg.style.display = 'none'; }, 2000);
    }

    if (btn && input) {
      btn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(input.value);
          showMsg('Link copied ✔', true);
        } catch (e) {
          showMsg('Could not copy. Please copy manually.', false);
        }
      });
    }

    // Web Share API (mobile-friendly)
    if (shareBtn && navigator.share) {
      shareBtn.addEventListener('click', async () => {
        try {
          await navigator.share({
            title: 'Join me on EZ360PM',
            text: 'Check out EZ360PM — manage projects, invoices & time in one place.',
            url: input ? input.value : '{{ link }}',
          });
        } catch (e) {
          // user cancelled — silently ignore
        }
      });
    } else if (shareBtn) {
      // Hide if not supported
      shareBtn.style.display = 'none';
    }
  })();
</script>
{% endblock %}
