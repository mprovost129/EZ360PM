{% extends "ops/_base.html" %}

{% block title %}Webhooks · Ops · EZ360PM{% endblock %}

{% block ops_title %}Webhook Health{% endblock %}
{% block ops_subtitle %}
  <div class="ez-ops-muted small">Stripe webhook processing reliability and Stripe mirror drift.</div>
{% endblock %}

{% block ops_actions %}
  <a class="btn btn-sm btn-outline-secondary" href="{% url 'billing:webhook_history' %}">
    <i class="bi bi-clock-history me-1"></i>Webhook history
  </a>
{% endblock %}

{% block ops_content %}
<div class="row g-3">
  <div class="col-12 col-lg-7">
    <div class="card ez-card">
      <div class="card-body">
        <div class="ez-kicker">Stripe</div>
        <h5 class="mb-2">Webhook processing</h5>
        <div class="text-muted small mb-3">Counts come from <code>BillingWebhookEvent</code>. “Failed” means our handler errored (ok=false).</div>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <div class="border rounded-3 p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="fw-semibold">24 hours</div>
                  <div class="text-muted small">received / handler errors</div>
                </div>
                <div class="text-end">
                  <div class="fs-4">{{ wh_total_24h }}</div>
                  <div class="text-muted small">{{ wh_failed_24h }} failed</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="border rounded-3 p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="fw-semibold">7 days</div>
                  <div class="text-muted small">received / handler errors</div>
                </div>
                <div class="text-end">
                  <div class="fs-4">{{ wh_total_7d }}</div>
                  <div class="text-muted small">{{ wh_failed_7d }} failed</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <hr class="my-3">

        <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
          <div>
            <div class="fw-semibold">Last webhook</div>
            <div class="text-muted small">Most recent <code>received_at</code></div>
          </div>
          <div class="text-end">
            {% if last_wh %}
              <div class="fw-semibold">{{ last_wh.received_at|date:"M j, Y g:ia" }}</div>
              <div class="text-muted small">
                {% if last_wh.ok %}ok{% else %}error{% endif %} · {{ last_wh.event_type|default:"stripe.event" }}
              </div>
            {% else %}
              <div class="text-muted">—</div>
            {% endif %}
          </div>
        </div>

        <hr class="my-3">

        <div class="ez-kicker">Traffic</div>
        <h6 class="mb-2">Top event types (7 days)</h6>
        {% if top_types_7d %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Event type</th>
                  <th class="text-end">Count</th>
                </tr>
              </thead>
              <tbody>
                {% for row in top_types_7d %}
                  <tr>
                    <td class="text-muted">{{ row.event_type|default:"(unknown)" }}</td>
                    <td class="text-end fw-semibold">{{ row.count }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted">No webhooks logged yet.</div>
        {% endif %}
      </div>
    </div>

    <div class="card ez-card mt-3">
      <div class="card-body">
        <div class="ez-kicker">Failures</div>
        <h5 class="mb-2">Recent webhook handler errors</h5>

        {% if recent_failures %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Received</th>
                  <th>Type</th>
                  <th>Error</th>
                </tr>
              </thead>
              <tbody>
                {% for e in recent_failures %}
                  <tr>
                    <td class="text-muted" style="white-space:nowrap;">{{ e.received_at|date:"Y-m-d H:i" }}</td>
                    <td>
                      <a class="text-decoration-none" href="{% url 'billing:webhook_event_detail' e.pk %}">{{ e.event_type|default:"stripe.event" }}</a>
                    </td>
                    <td class="text-muted small">{{ e.error|default:""|truncatechars:120 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted">No recent handler failures.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-5">
    <div class="card ez-card">
      <div class="card-body">
        <div class="ez-kicker">Stripe mirror</div>
        <h5 class="mb-2">Subscription drift / staleness</h5>
        <div class="text-muted small mb-3">Stale means no subscription-touching Stripe event updated the mirror within <b>{{ stale_hours }} hours</b>.</div>

        <div class="border rounded-3 p-3">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">Stale subscriptions</div>
              <div class="text-muted small">Cutoff: {{ stale_cutoff|date:"M j, Y g:ia" }}</div>
            </div>
            <div class="text-end">
              <div class="fs-4">{{ stale_sub_count }}</div>
              <div class="text-muted small">needs review</div>
            </div>
          </div>

          {% if stale_sub_sample %}
            <div class="mt-3">
              <div class="text-muted small mb-1">Oldest examples</div>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Company</th>
                      <th class="text-end">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in stale_sub_sample %}
                      <tr>
                        <td>
                          <a class="text-decoration-none" href="{% url 'ops:company_detail' company_id=row.company_id %}">{{ row.company__name }}</a>
                          <div class="text-muted small">{% if row.last_stripe_event_at %}{{ row.last_stripe_event_at|date:"M j, Y g:ia" }}{% else %}never synced{% endif %}</div>
                        </td>
                        <td class="text-end"><span class="badge text-bg-light">{{ row.status }}</span></td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endif %}
        </div>

        <div class="mt-3">
          <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'ops:settings_site' %}">
            <i class="bi bi-gear me-1"></i>Mirror drift settings
          </a>
        </div>
      </div>
    </div>

    <div class="card ez-card mt-3">
      <div class="card-body">
        <div class="ez-kicker">Operator workflow</div>
        <div class="text-muted small">
          If drift grows, it usually means a webhook endpoint secret mismatch, disabled endpoint, delivery failures, or the app isn’t processing events.
          Use this page to find impacted tenants quickly, then drill into Company 360.
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
