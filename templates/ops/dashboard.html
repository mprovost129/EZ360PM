{% extends "ops/_base.html" %}
{% load static dict_extras %}

{% block title %}Ops · EZ360PM{% endblock %}

{% block extra_js %}
<script>
(function(){
  function copyText(text){
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(function(){}, function(){});
      return;
    }
    var ta=document.createElement("textarea");
    ta.value=text; ta.setAttribute("readonly","");
    ta.style.position="absolute"; ta.style.left="-9999px";
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand("copy"); }catch(e){}
    document.body.removeChild(ta);
  }
  document.addEventListener("click", function(e){
    var btn=e.target.closest("[data-copy-company-id]");
    if(!btn) return;
    e.preventDefault();
    copyText(btn.getAttribute("data-copy-company-id"));
    btn.textContent="Copied";
    setTimeout(function(){ btn.textContent="Copy ID"; }, 1200);
  });
  document.addEventListener("click", function(e){
    var btn=e.target.closest("#copyCronCmds");
    if(!btn) return;
    e.preventDefault();
    var pre=document.getElementById("cronCmds");
    if(!pre) return;
    copyText(pre.textContent || pre.innerText || "");
    btn.textContent="Copied";
    setTimeout(function(){ btn.textContent="Copy commands"; }, 1200);
  });
})();
</script>
{% endblock %}

{% block ops_title %}Ops Center{% endblock %}
{% block ops_subtitle %}
  <div class="ez-ops-muted small">Executive operations console for platform health, billing, security, and customer support.</div>
{% endblock %}

{% block ops_actions %}
  <form class="d-flex gap-2" method="get" action="{% url 'ops:dashboard' %}">
    <input class="form-control ez-ops-search" name="q" value="{{ q }}" placeholder="Search companies or emails…">
    <button class="btn btn-dark ez-ops-btn" type="submit"><i class="bi bi-search me-1"></i>Search</button>
  </form>
{% endblock %}

{% block ops_content %}

<div class="row g-3">
  <div class="col-md-2">
    <div class="ez-ops-kpi">
      <div class="ez-ops-kpi__label">Companies</div>
      <div class="ez-ops-kpi__value">{{ metrics.companies_total }}</div>
      <div class="ez-ops-kpi__meta">Total tenants created</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="ez-ops-kpi">
      <div class="ez-ops-kpi__label">MRR</div>
      <div class="ez-ops-kpi__value">${{ metrics.mrr_total }}</div>
      <div class="ez-ops-kpi__meta">Paid + past due (est.)</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="ez-ops-kpi">
      <div class="ez-ops-kpi__label">ARR</div>
      <div class="ez-ops-kpi__value">${{ metrics.arr_total }}</div>
      <div class="ez-ops-kpi__meta">Annualized (est.)</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="ez-ops-kpi">
      <div class="ez-ops-kpi__label">Paid</div>
      <div class="ez-ops-kpi__value">{{ metrics.active_paid }}</div>
      <div class="ez-ops-kpi__meta">Active subscriptions</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="ez-ops-kpi">
      <div class="ez-ops-kpi__label">Trialing</div>
      <div class="ez-ops-kpi__value">{{ metrics.trialing }}</div>
      <div class="ez-ops-kpi__meta">In trial</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="ez-ops-kpi">
      <div class="ez-ops-kpi__label">Open alerts</div>
      <div class="ez-ops-kpi__value">{{ metrics.open_alerts }}</div>
      <div class="ez-ops-kpi__meta">
        <a class="text-decoration-none" href="{% url 'ops:alerts' %}?status=open">View triage</a>
        <a class="ms-2 text-decoration-none" href="{% url 'ops:companies' %}">Companies</a>
        {% if metrics.open_qa_issues %}
          <span class="ms-2 ez-ops-badge">QA {{ metrics.open_qa_issues }}</span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-lg-7">
    <div class="card ez-ops-card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div class="fw-semibold">Platform health snapshot</div>
        <a class="btn btn-sm btn-outline-dark ez-ops-btn" href="{% url 'ops:system_status' %}">
          <i class="bi bi-activity me-1"></i>System details
        </a>
      </div>
      <div class="card-body">
        <div class="row g-2 small">
          <div class="col-md-6"><span class="ez-ops-muted">Environment:</span> <span class="fw-semibold">{{ system_status.app_environment|default:"" }}</span></div>
          <div class="col-md-6"><span class="ez-ops-muted">Settings:</span> <span class="fw-semibold">{{ system_status.settings_module }}</span></div>

          <div class="col-md-3"><span class="ez-ops-muted">DEBUG:</span> <span class="fw-semibold">{{ system_status.debug }}</span></div>
          <div class="col-md-3"><span class="ez-ops-muted">SSL redirect:</span> <span class="fw-semibold">{{ system_status.secure_ssl_redirect }}</span></div>
          <div class="col-md-3"><span class="ez-ops-muted">Session secure:</span> <span class="fw-semibold">{{ system_status.session_cookie_secure }}</span></div>
          <div class="col-md-3"><span class="ez-ops-muted">CSRF secure:</span> <span class="fw-semibold">{{ system_status.csrf_cookie_secure }}</span></div>

          <div class="col-12"><span class="ez-ops-muted">Email backend:</span> <span class="fw-semibold">{{ system_status.email_backend }}</span></div>
          <div class="col-12"><span class="ez-ops-muted">Cache backend:</span> <span class="fw-semibold">{{ system_status.cache_backend }}</span></div>
          <div class="col-12"><span class="ez-ops-muted">Sentry enabled:</span> <span class="fw-semibold">{{ system_status.sentry_enabled }}</span></div>
        </div>

        {% if scheduler_warnings %}
          <hr>
          <div class="fw-semibold mb-1"><i class="bi bi-exclamation-triangle me-1"></i>Configuration warnings</div>
          <ul class="small mb-0">
            {% for w in scheduler_warnings %}
              <li>{{ w }}</li>
            {% endfor %}
          </ul>
        {% endif %}

        <hr>
        <div class="d-flex align-items-center justify-content-between">
          <div class="fw-semibold">Scheduled commands</div>
          <button class="btn btn-sm btn-outline-dark ez-ops-btn" id="copyCronCmds"><i class="bi bi-clipboard me-1"></i>Copy commands</button>
        </div>
        <pre id="cronCmds" class="mt-2 mb-0 p-2 rounded" style="background: rgba(0,0,0,.03); border: 1px solid rgba(0,0,0,.06);">{{ cron_commands }}</pre>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card ez-ops-card mb-3">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div class="fw-semibold">Alert triage</div>
        <a class="btn btn-sm btn-outline-dark ez-ops-btn" href="{% url 'ops:alerts' %}?status=open">Open alerts</a>
      </div>
      <div class="card-body">
        {% if open_alert_by_source %}
          <div class="small ez-ops-muted mb-2">By source</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle ez-ops-table mb-2">
              <thead>
                <tr><th>Source</th><th class="text-end">Open</th></tr>
              </thead>
              <tbody>
                {% for row in open_alert_by_source %}
                  <tr>
                    <td class="fw-semibold">{{ row.source }}</td>
                    <td class="text-end"><span class="ez-ops-badge">{{ row.total }}</span></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-secondary small">No open alerts.</div>
        {% endif %}

        {% if open_alert_groups %}
          <div class="small ez-ops-muted mt-3 mb-2">By company</div>
          <div class="table-responsive">
            <table class="table table-sm align-middle ez-ops-table mb-0">
              <thead>
                <tr><th>Company</th><th>Source</th><th class="text-end">Open</th></tr>
              </thead>
              <tbody>
                {% for row in open_alert_groups %}
                  <tr>
                    <td class="fw-semibold">
                      {% if row.company_id %}
                        <a class="text-decoration-none" href="{% url 'ops:company_detail' row.company_id %}">{{ row.company__name|default:"(Deleted company)" }}</a>
                      {% else %}
                        <span class="text-secondary">Platform</span>
                      {% endif %}
                    </td>
                    <td class="text-secondary">{{ row.source }}</td>
                    <td class="text-end"><span class="ez-ops-badge">{{ row.total }}</span></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="card ez-ops-card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div class="fw-semibold">Quick links</div>
        <a class="btn btn-sm btn-outline-dark ez-ops-btn" href="{% url 'ops:settings_home' %}"><i class="bi bi-gear me-1"></i>Settings</a>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a class="btn btn-outline-dark ez-ops-btn" href="{% url 'ops:launch_checks' %}"><i class="bi bi-rocket-takeoff me-1"></i>Launch checks</a>
          <a class="btn btn-outline-dark ez-ops-btn" href="{% url 'ops:security' %}"><i class="bi bi-shield-lock me-1"></i>Security</a>
          <a class="btn btn-outline-dark ez-ops-btn" href="{% url 'ops:backups' %}"><i class="bi bi-hdd-stack me-1"></i>Backups</a>
          <a class="btn btn-outline-dark ez-ops-btn" href="{% url 'ops:reconciliation' %}"><i class="bi bi-calculator me-1"></i>Reconciliation</a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card ez-ops-card mt-3">
  <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
    <div class="fw-semibold">Companies</div>
    <div class="text-secondary small">Newest first · showing up to 200</div>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0 ez-ops-table">
        <thead>
          <tr>
            <th>Company</th>
            <th>Owner</th>
            <th class="text-end">Users</th>
            <th class="text-end">Seats</th>
            <th>Status</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td>
                <div class="fw-semibold">
                  <a class="text-decoration-none" href="{% url 'ops:company_detail' r.company.id %}">{{ r.company.name }}</a>
                </div>
                <div class="small ez-ops-muted">
                  <span class="me-2">Created {{ r.company.created_at|date:"Y-m-d" }}</span>
                  <button class="btn btn-sm btn-outline-dark ez-ops-btn" data-copy-company-id="{{ r.company.id }}">Copy ID</button>
                </div>
              </td>
              <td class="small">
                <div class="fw-semibold">{{ r.company.owner.email }}</div>
              </td>
              <td class="text-end">{{ r.employee_count }}</td>
              <td class="text-end">{{ r.seats_limit }}</td>
              <td class="small">
                {% if r.subscription %}
                  <span class="ez-ops-badge">{{ r.subscription.status }}</span>
                {% else %}
                  <span class="text-secondary">No subscription</span>
                {% endif %}
              </td>
              <td class="text-end">
                <a class="btn btn-sm btn-outline-dark ez-ops-btn" href="{% url 'ops:company_timeline' r.company.id %}"><i class="bi bi-clock-history me-1"></i>Timeline</a>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6" class="text-center text-secondary py-4">No companies found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
