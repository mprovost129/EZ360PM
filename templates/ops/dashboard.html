{% extends "base_app.html" %}
{% load static dict_extras %}
{% block title %}Ops · EZ360PM<script>
(function(){
  function copyText(text){
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(function(){}, function(){});
      return;
    }
    var ta=document.createElement("textarea");
    ta.value=text; ta.setAttribute("readonly","");
    ta.style.position="absolute"; ta.style.left="-9999px";
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand("copy"); }catch(e){}
    document.body.removeChild(ta);
  }
  document.addEventListener("click", function(e){
    var btn=e.target.closest("[data-copy-company-id]");
    if(!btn) return;
    e.preventDefault();
    copyText(btn.getAttribute("data-copy-company-id"));
    btn.textContent="Copied";
    setTimeout(function(){ btn.textContent="Copy ID"; }, 1200);
  });

  document.addEventListener("click", function(e){
    var btn=e.target.closest("#copyCronCmds");
    if(!btn) return;
    e.preventDefault();
    var pre=document.getElementById("cronCmds");
    if(!pre) return;
    copyText(pre.textContent || pre.innerText || "");
    btn.textContent="Copied";
    setTimeout(function(){ btn.textContent="Copy commands"; }, 1200);
  });
})();
</script>
{% endblock %}
{% block content %}
<div class="container-fluid" style="max-width: 1200px;">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1">Ops Console</h1>
      <div class="text-secondary small">Internal tools for staff. Use support mode for safe access.</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-dark" href="{% url 'ops:alerts' %}">
        Alerts
        {% if metrics.open_alerts %}
          <span class="badge text-bg-danger ms-1">{{ metrics.open_alerts }}</span>
        {% endif %}
      </a>
      <a class="btn btn-outline-dark" href="{% url 'ops:system_status' %}">System status</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:smoke_tests' %}">Smoke tests</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:alert_routing' %}">Alert routing</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:slo_dashboard' %}">SLO dashboard</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:launch_checks' %}">Launch checks</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:checks' %}">Ops checks</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:launch_gate' %}">Launch gate</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:go_live_runbook' %}">Go-live runbook</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:reconciliation' %}">Reconciliation</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:drift_tools' %}">Drift toolkit</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:security' %}">Security</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:email_test' %}">Email test</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:probes' %}">Probes</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:retention' %}">Retention</a>
      <a class="btn btn-outline-dark btn-sm" href="{% url 'ops:backups' %}"><i class="bi bi-hdd-stack me-1"></i>Backups</a>
      <a class="btn btn-outline-dark btn-sm" href="{% url 'ops:releases' %}"><i class="bi bi-tag me-1"></i>Releases</a>
    </div>
    <form class="d-flex gap-2" method="get">
      <input class="form-control" name="q" value="{{ q }}" placeholder="Search companies or emails…" style="min-width: 280px;">
      <button class="btn btn-dark" type="submit">Search</button>
    </form>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-secondary small">Companies</div>
          <div class="fs-4 fw-semibold">{{ metrics.companies_total }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-secondary small">Subscriptions</div>
          <div class="fs-4 fw-semibold">{{ metrics.companies_with_subscription }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-secondary small">Active / Trialing / Past due</div>
          <div class="fs-4 fw-semibold">{{ metrics.active_subscriptions }}</div>
        </div>
      </div>
    </div>
  </div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <div class="fw-semibold">System status</div>
        <div class="text-secondary small">Snapshot of runtime configuration (no secrets).</div>
      </div>
    </div>
    <div class="row g-2 mt-2 small">
      <div class="col-md-4"><span class="text-secondary">Settings:</span> {{ system_status.settings_module }}</div>
      <div class="col-md-2"><span class="text-secondary">DEBUG:</span> {{ system_status.debug }}</div>
      <div class="col-md-3"><span class="text-secondary">SSL redirect:</span> {{ system_status.secure_ssl_redirect }}</div>
      <div class="col-md-3"><span class="text-secondary">Sentry enabled:</span> {{ system_status.sentry_enabled }}</div>
      <div class="col-md-6"><span class="text-secondary">Email backend:</span> {{ system_status.email_backend }}</div>
      <div class="col-md-6"><span class="text-secondary">Cache backend:</span> {{ system_status.cache_backend }}</div>
      <div class="col-12"><span class="text-secondary">ALLOWED_HOSTS:</span> {{ system_status.allowed_hosts }}</div>
    </div>
  </div>
</div>


<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex flex-wrap align-items-start justify-content-between gap-2">
      <div>
        <div class="fw-semibold">Open alerts summary</div>
        <div class="text-muted small">Grouped view to help triage the noisiest sources/companies.</div>
      </div>
      <a class="btn btn-sm btn-outline-dark" href="{% url 'ops:alerts' %}?status=open">View open alerts</a>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-lg-4">
        <div class="text-secondary small mb-1">By source</div>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr><th>Source</th><th class="text-end">Open</th>
                <th class="text-end">Snooze</th>
                <th class="text-end">Snooze</th></tr>
            </thead>
            <tbody>
              {% for r in open_alert_by_source %}
                <tr>
                  <td class="text-secondary small">{{ r.source }}</td>
                  <td class="text-end"><a class="text-decoration-none" href="{% url 'ops:alerts' %}?status=open&source={{ r.source }}">{{ r.total }}</a></td>
                  <td class="text-end">
                    {% with snooze_key=r.source|add:":platform" %}
                      {% with info=snooze_map|get_item:snooze_key %}
                      {% if info %}
                        <span class="badge text-bg-warning me-1">Snoozed</span>
                        <span class="text-muted small">until {{ info.until|date:'M j, Y g:i A' }}</span>
                        <form method="post" action="{% url 'ops:alert_snooze_clear' %}" class="d-inline ms-1">
                          {% csrf_token %}
                          <input type="hidden" name="source" value="{{ r.source }}">
                          <button class="btn btn-xs btn-outline-danger" type="submit" title="Clear snooze">Clear</button>
                        </form>
                      {% endif %}
                      {% endwith %}
                    {% endwith %}
                    <form method="post" action="{% url 'ops:alert_snooze' %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="source" value="{{ r.source }}">
                      <input type="hidden" name="minutes" value="30">
                      <button class="btn btn-xs btn-outline-secondary" type="submit" title="Snooze 30 minutes">30m</button>
                    </form>
                    <form method="post" action="{% url 'ops:alert_snooze' %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="source" value="{{ r.source }}">
                      <input type="hidden" name="minutes" value="120">
                      <button class="btn btn-xs btn-outline-secondary" type="submit" title="Snooze 2 hours">2h</button>
                    </form>
                    <form method="post" action="{% url 'ops:alert_snooze' %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="source" value="{{ r.source }}">
                      <input type="hidden" name="minutes" value="1440">
                      <button class="btn btn-xs btn-outline-secondary" type="submit" title="Snooze 1 day">1d</button>
                    </form>
                    <form method="post" action="{% url 'ops:alert_snooze' %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="source" value="{{ r.source }}">
                      <input type="hidden" name="minutes" value="10080">
                      <button class="btn btn-xs btn-outline-secondary" type="submit" title="Snooze 7 days">7d</button>
                    </form>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="4" class="text-secondary small p-2">No open alerts.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="text-secondary small mb-1">By source + company (top 25)</div>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Source</th>
                <th>Company</th>
                <th class="text-end">Open</th>
              </tr>
            </thead>
            <tbody>
              {% for r in open_alert_groups %}
                <tr>
                  <td class="text-secondary small">{{ r.source }}</td>
                  <td class="text-secondary small">{% if r.company__name %}{{ r.company__name }}{% else %}—{% endif %}</td>
                  <td class="text-end">
                    <a class="text-decoration-none" href="{% url 'ops:alerts' %}?status=open&source={{ r.source }}{% if r.company_id %}&company_id={{ r.company_id }}{% endif %}">{{ r.total }}</a>
                  </td>
                  <td class="text-end">
                    {% with scope=r.company_id|default:"platform" %}
                      {% with snooze_key=r.source|add:":"|add:scope %}
                      {% with info=snooze_map|get_item:snooze_key %}
                      {% if info %}
                        <span class="badge text-bg-warning me-1">Snoozed</span>
                        <span class="text-muted small">until {{ info.until|date:'M j, Y g:i A' }}</span>
                        <form method="post" action="{% url 'ops:alert_snooze_clear' %}" class="d-inline ms-1">
                          {% csrf_token %}
                          <input type="hidden" name="source" value="{{ r.source }}">
                          {% if r.company_id %}<input type="hidden" name="company_id" value="{{ r.company_id }}">{% endif %}
                          <button class="btn btn-xs btn-outline-danger" type="submit" title="Clear snooze">Clear</button>
                        </form>
                      {% endif %}
                      {% endwith %}
                    {% endwith %}
                    {% endwith %}
                    <form method="post" action="{% url 'ops:alert_snooze' %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="source" value="{{ r.source }}">
                      {% if r.company_id %}<input type="hidden" name="company_id" value="{{ r.company_id }}">{% endif %}
                      <input type="hidden" name="minutes" value="30">
                      <button class="btn btn-xs btn-outline-secondary" type="submit" title="Snooze 30 minutes">30m</button>
                    </form>
                    <form method="post" action="{% url 'ops:alert_snooze' %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="source" value="{{ r.source }}">
                      {% if r.company_id %}<input type="hidden" name="company_id" value="{{ r.company_id }}">{% endif %}
                      <input type="hidden" name="minutes" value="120">
                      <button class="btn btn-xs btn-outline-secondary" type="submit" title="Snooze 2 hours">2h</button>
                    </form>
                    <form method="post" action="{% url 'ops:alert_snooze' %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="source" value="{{ r.source }}">
                      {% if r.company_id %}<input type="hidden" name="company_id" value="{{ r.company_id }}">{% endif %}
                      <input type="hidden" name="minutes" value="1440">
                      <button class="btn btn-xs btn-outline-secondary" type="submit" title="Snooze 1 day">1d</button>
                    </form>
                    <form method="post" action="{% url 'ops:alert_snooze' %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="source" value="{{ r.source }}">
                      {% if r.company_id %}<input type="hidden" name="company_id" value="{{ r.company_id }}">{% endif %}
                      <input type="hidden" name="minutes" value="10080">
                      <button class="btn btn-xs btn-outline-secondary" type="submit" title="Snooze 7 days">7d</button>
                    </form>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="4" class="text-secondary small p-2">No open alerts.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex align-items-start justify-content-between gap-3">
      <div>
        <div class="fw-semibold">Scheduled jobs (copy/paste)</div>
        <div class="text-muted small">Recommended cron commands for production (Render cron jobs, Linux cron, Windows Task Scheduler).</div>
      </div>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="copyCronCmds">
        <i class="bi bi-clipboard me-1"></i>Copy commands
      </button>
    </div>
    <pre id="cronCmds" class="small mb-0 mt-3" style="white-space: pre-wrap;">{{ cron_commands }}</pre>
    {% if scheduler_warnings %}
      <div class="alert alert-warning mt-3 mb-0">
        <div class="fw-semibold">Scheduler sanity warnings</div>
        <ul class="mb-0 small">
          {% for w in scheduler_warnings %}
            <li>{{ w }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>
</div>



  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
          <div class="fw-semibold">Recent alerts</div>
          <div class="text-secondary small">Last 20 alerts (open and resolved).</div>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-sm btn-outline-dark" href="{% url 'ops:alerts' %}">All alerts</a>
        </div>
<form method="post" action="{% url 'ops:alert_send_test' %}" class="d-flex flex-wrap gap-2 mt-2">
  {% csrf_token %}
  <select name="level" class="form-select form-select-sm" style="max-width: 180px;">
    <option value="warn">Warning</option>
    <option value="error">Error</option>
    <option value="info">Info</option>
  </select>
  <input type="text" name="message" class="form-control form-control-sm" style="max-width: 360px;" placeholder="Optional message (test)">
  <button class="btn btn-sm btn-outline-dark" type="submit"><i class="bi bi-bell me-1"></i>Send test alert</button>
  <a class="btn btn-sm btn-outline-secondary" href="{% url 'ops:alert_routing' %}">Alert routing</a>
</form>
      </div>
      <div class="table-responsive mt-2">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>When</th>
              <th>Level</th>
              <th>Source</th>
              <th>Company</th>
              <th>Title</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for a in recent_alerts %}
              <tr>
                <td class="text-secondary small">{{ a.created_at|date:"Y-m-d H:i" }}</td>
                <td><span class="badge {% if a.level == 'critical' %}text-bg-danger{% elif a.level == 'error' %}text-bg-danger{% elif a.level == 'warning' %}text-bg-warning{% else %}text-bg-secondary{% endif %} text-uppercase">{{ a.level }}</span></td>
                <td class="text-secondary small">{{ a.source }}</td>
                <td class="text-secondary small">{% if a.company %}{{ a.company.name }}{% else %}—{% endif %}</td>
                <td style="max-width: 360px;"><div class="text-truncate" style="max-width: 360px;"><a class="text-decoration-none" href="{% url 'ops:alert_detail' a.id %}">{{ a.title }}</a></div></td>
                <td>
                  {% if a.is_resolved %}
                    <span class="badge text-bg-success">Resolved</span>
                  {% else %}
                    <span class="badge text-bg-danger">Open</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-secondary p-2">No alerts.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Company</th>
              <th>Owner</th>
              <th>Plan</th>
              <th>Status</th>
              <th class="text-end">Seats</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr>
                <td class="fw-semibold">{{ r.company.name }}</td>
                <td class="text-secondary small">{{ r.company.owner.email }}</td>
                <td>
                  {% if r.subscription %}
                    <span class="badge text-bg-dark text-uppercase">{{ r.subscription.plan }}</span>
                    <span class="text-secondary small">{{ r.subscription.billing_interval }}</span>
                  {% else %}
                    <span class="text-secondary">—</span>
                  {% endif %}
                </td>
                <td>
                  {% if r.subscription %}
                    <span class="badge text-bg-secondary text-uppercase">{{ r.subscription.status }}</span>
                  {% else %}
                    <span class="text-secondary">—</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <span class="text-secondary small">{{ r.employee_count }}</span>
                  <span class="text-secondary small">/</span>
                  <span class="small">{{ r.seats_limit }}</span>
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-dark" href="{% url 'ops:company_detail' r.company.id %}">Open</a>
                  <button type="button" class="btn btn-sm btn-outline-secondary ms-1" data-copy-company-id="{{ r.company.id }}">Copy ID</button>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="p-3 text-secondary">No results.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  function copyText(text){
    if (!text) return;
    if (navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(function(){}, function(){});
      return;
    }
    var ta=document.createElement("textarea");
    ta.value=text; ta.setAttribute("readonly","");
    ta.style.position="absolute"; ta.style.left="-9999px";
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand("copy"); }catch(e){}
    document.body.removeChild(ta);
  }
  document.addEventListener("click", function(e){
    var btn=e.target.closest("[data-copy-company-id]");
    if(!btn) return;
    e.preventDefault();
    copyText(btn.getAttribute("data-copy-company-id"));
    btn.textContent="Copied";
    setTimeout(function(){ btn.textContent="Copy ID"; }, 1200);
  });
})();
</script>
{% endblock %}