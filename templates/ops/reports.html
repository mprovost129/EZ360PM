{% extends "ops/_base.html" %}

{% block ops_title %}Operational Reports{% endblock %}
{% block ops_subtitle %}Billing health, churn, trials, and reliability signals (best-effort).{% endblock %}

{% block ops_actions %}
  <a class="btn btn-sm btn-outline-secondary" href="{% url 'ops:companies' %}">
    <i class="bi bi-buildings me-1"></i>Companies
  </a>
{% endblock %}

{% block ops_content %}
<div class="row g-3">
  <div class="col-12 col-lg-8">
    <div class="card ez-card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
          <div>
            <div class="ez-kicker">Revenue snapshot</div>
            <h5 class="mb-1">Platform MRR / ARR</h5>
            <div class="text-muted small">Computed from subscriptions (comped + trialing excluded).</div>
          </div>
          <div class="text-end">
            <div class="display-6 mb-0">${{ total_mrr|floatformat:2 }}</div>
            <div class="text-muted">MRR</div>
          </div>
        </div>

        <hr class="my-3">

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <div class="ez-metric">
              <div class="ez-metric__label">ARR</div>
              <div class="ez-metric__value">${{ total_arr|floatformat:2 }}</div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="ez-metric">
              <div class="ez-metric__label">Paid companies</div>
              <div class="ez-metric__value">{{ paid_count }}</div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="ez-metric">
              <div class="ez-metric__label">Revenue at risk</div>
              <div class="ez-metric__value">${{ revenue_at_risk|floatformat:2 }}</div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="ez-metric">
              <div class="ez-metric__label">As of</div>
              <div class="ez-metric__value">{{ now|date:"M j, Y g:ia" }}</div>
            </div>
          </div>

        <hr class="my-3">

        <div class="ez-kicker">Trend</div>
        <h6 class="mb-2">MRR trend (30 days)</h6>
        {% if recent_snapshots_display %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Date</th>
                  <th class="text-end">MRR</th>
                  <th class="text-end">ARR</th>
                  <th class="text-end">At risk</th>
                </tr>
              </thead>
              <tbody>
                {% for s in recent_snapshots_display %}
                  <tr>
                    <td class="text-muted">{{ s.date|date:"M j" }}</td>
                    <td class="text-end fw-semibold">${{ s.mrr|floatformat:2 }}</td>
                    <td class="text-end">${{ s.arr|floatformat:2 }}</td>
                    <td class="text-end">${{ s.at_risk|floatformat:2 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted small">No snapshots yet. Run <code>python manage.py ez360_snapshot_platform_revenue</code>.</div>
        {% endif %}
        </div>

      </div>
    </div>

    <div class="card ez-card mt-3">
      <div class="card-body">
        <div class="ez-kicker">Billing health</div>
        <h5 class="mb-2">Stripe webhooks & payment failures</h5>
        <div class="mt-2">
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'ops:webhook_health' %}"><i class="bi bi-plug me-1"></i>Webhook health</a>
        </div>
        <div class="text-muted small mb-3">
          Webhook “failed” means our handler errored (ok=false). Payment failures are Stripe event types indicating collection issues.
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <div class="border rounded-3 p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="fw-semibold">Webhook processing (24h)</div>
                  <div class="text-muted small">received / handler errors</div>
                </div>
                <div class="text-end">
                  <div class="fs-4">{{ wh_total_24h }}</div>
                  <div class="text-muted small">{{ wh_failed_24h }} failed</div>
                </div>
              </div>
                          </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="border rounded-3 p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="fw-semibold">Webhook processing (7d)</div>
                  <div class="text-muted small">received / handler errors</div>
                </div>
                <div class="text-end">
                  <div class="fs-4">{{ wh_total_7d }}</div>
                  <div class="text-muted small">{{ wh_failed_7d }} failed</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="border rounded-3 p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="fw-semibold">Payment failures (7d)</div>
                  <div class="text-muted small">invoice/payment intent/charge failed</div>
                </div>
                <div class="text-end">
                  <div class="fs-4">{{ payment_failed_7d }}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="border rounded-3 p-3">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="fw-semibold">Payment failures (30d)</div>
                  <div class="text-muted small">invoice/payment intent/charge failed</div>
                </div>
                <div class="text-end">
                  <div class="fs-4">{{ payment_failed_30d }}</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="card ez-card mt-3">
      <div class="card-body">
        <div class="ez-kicker">Growth</div>
        <h5 class="mb-2">Lifecycle funnel (30 days)</h5>

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <div class="ez-metric">
              <div class="ez-metric__label">Trials started</div>
              <div class="ez-metric__value">{{ trials_started_30 }}</div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="ez-metric">
              <div class="ez-metric__label">Trial conversions</div>
              <div class="ez-metric__value">{{ conversions_30 }}</div>
              <div class="text-muted small">{{ conversion_rate_30|floatformat:2 }} rate</div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="ez-metric">
              <div class="ez-metric__label">Churned</div>
              <div class="ez-metric__value">{{ churn_30 }}</div>
              <div class="text-muted small">{{ churn_rate_30|floatformat:2 }} rate</div>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="ez-metric">
              <div class="ez-metric__label">New subs started</div>
              <div class="ez-metric__value">{{ starts_30 }}</div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="ez-metric">
              <div class="ez-metric__label">Reactivations</div>
              <div class="ez-metric__value">{{ reactivations_30 }}</div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="ez-metric">
              <div class="ez-metric__label">Net growth</div>
              <div class="ez-metric__value">{{ net_growth_30 }}</div>
            </div>
          </div>
        </div>

        <div class="text-muted small mt-2">
          Lifecycle metrics are derived from <code>CompanyLifecycleEvent</code> entries generated by Stripe webhook transitions.
        </div>

        {% if lifecycle_recent %}
          <hr class="my-3">
          <div class="ez-kicker">Recent activity</div>
          <h6 class="mb-2">Latest lifecycle events</h6>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>When</th>
                  <th>Company</th>
                  <th>Event</th>
                </tr>
              </thead>
              <tbody>
                {% for e in lifecycle_recent %}
                  <tr>
                    <td class="text-muted" style="white-space:nowrap;">{{ e.occurred_at|date:"Y-m-d H:i" }}</td>
                    <td>
                      <a class="text-decoration-none" href="{% url 'ops:company_detail' company_id=e.company_id %}">{{ e.company.name }}</a>
                    </td>
                    <td><span class="badge text-bg-light">{{ e.get_event_type_display }}</span></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </div>

  <div class="col-12 col-lg-4">
    <div class="card ez-card">
      <div class="card-body">
        <div class="ez-kicker">Stripe health</div>
        <h5 class="mb-2">Webhook freshness & drift</h5>

        <div class="border rounded-3 p-3 mb-3">
          <div class="d-flex justify-content-between">
            <div>
              <div class="fw-semibold">Last webhook received</div>
              <div class="text-muted small">BillingWebhookEvent.received_at</div>
            </div>
            <div class="text-end">
              {% if last_wh_received_at %}
                <div class="fw-semibold">{{ last_wh_received_at|date:"M j, Y g:ia" }}</div>
                <div class="text-muted small">{% if last_wh_ok %}ok{% else %}error{% endif %}</div>
              {% else %}
                <div class="text-muted">—</div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="border rounded-3 p-3">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">Mirror drift</div>
              <div class="text-muted small">stale &gt; {{ stripe_mirror_stale_after_hours }}h (level: {{ stripe_mirror_stale_alert_level }})</div>
            </div>
            <div class="text-end">
              <div class="fs-4">{{ stripe_mirror_stale_sub_count }}</div>
              <div class="text-muted small">subscriptions stale</div>
            </div>
          </div>

          {% if stripe_mirror_stale_sub_sample %}
            <div class="mt-3">
              <div class="text-muted small mb-1">Oldest examples</div>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Company</th>
                      <th class="text-end">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in stripe_mirror_stale_sub_sample %}
                      <tr>
                        <td>
                          <a class="text-decoration-none" href="{% url 'ops:company_detail' company_id=row.company_id %}">{{ row.company__name }}</a>
                          <div class="text-muted small">{% if row.last_stripe_event_at %}{{ row.last_stripe_event_at|date:"M j, Y g:ia" }}{% else %}never synced{% endif %}</div>
                        </td>
                        <td class="text-end"><span class="badge text-bg-light">{{ row.status }}</span></td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endif %}
        </div>

        <div class="mt-3">
          <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'ops:settings_site' %}">
            <i class="bi bi-gear me-1"></i>Stripe health settings
          </a>
        </div>
      </div>
    </div>


    <div class="card ez-card">
      <div class="card-body">
        <div class="ez-kicker">Observability</div>
        <h5 class="mb-2">Sentry</h5>

        {% if sentry_enabled %}
          <div class="text-muted small">Sentry is configured and capturing application errors.</div>
          {% if sentry_dashboard_url %}
            <div class="mt-2">
              <a class="btn btn-sm btn-outline-secondary w-100" href="{{ sentry_dashboard_url }}" target="_blank" rel="noopener">
                <i class="bi bi-box-arrow-up-right me-1"></i>Open Sentry dashboard
              </a>
            </div>
          {% else %}
            <div class="mt-2 text-muted small">Set <code>SENTRY_DASHBOARD_URL</code> to show a direct link here.</div>
          {% endif %}
        {% else %}
          <div class="text-muted">Sentry is not configured (SENTRY_DSN is empty).</div>
        {% endif %}
      </div>
    </div>

    <div class="card ez-card">
      <div class="card-body">
        <div class="ez-kicker">Reliability</div>
        <h5 class="mb-2">Unresolved alerts (last 7 days)</h5>

        {% if alerts_7d %}
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Source</th>
                  <th class="text-end">Count</th>
                </tr>
              </thead>
              <tbody>
                {% for row in alerts_7d %}
                  <tr>
                    <td class="text-muted">{{ row.source }}</td>
                    <td class="text-end fw-semibold">{{ row.count }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="mt-2">
            <a class="btn btn-sm btn-outline-secondary w-100" href="{% url 'ops:alerts' %}">
              <i class="bi bi-bell me-1"></i>Open Alerts
            </a>
          </div>
        {% else %}
          <div class="text-muted">No unresolved alerts in the last 7 days.</div>
        {% endif %}
      </div>
    </div>

    <div class="card ez-card mt-3">
      <div class="card-body">
        <div class="ez-kicker">Operator notes</div>
        <div class="text-muted small">
          Reports are computed from existing data sources (subscriptions + webhook event log + ops alerts). As we launch,
          we should promote lifecycle signals into explicit event tables for accurate conversion/churn analytics.
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
