{% extends "ops/_base.html" %}
{% block title %}Site settings · Ops · EZ360PM{% endblock %}

{% block ops_title %}Site settings{% endblock %}
{% block ops_subtitle %}<div class="ez-ops-muted small">Branding, email, storage, and platform defaults.</div>{% endblock %}
{% block ops_actions %}<a class="btn btn-outline-dark ez-ops-btn" href="{% url 'ops:settings_home' %}"><i class="bi bi-arrow-left me-1"></i>Settings</a>{% endblock %}

{% block ops_content %}
<div class="row g-2 align-items-end">
        <div class="col-12">
          <div class="form-check">
            {{ form.maintenance_mode_enabled }}
            <label class="form-check-label" for="{{ form.maintenance_mode_enabled.id_for_label }}">Enable maintenance mode</label>
          </div>
        </div>
        <div class="col-12">
          <div class="form-check">
            {{ form.maintenance_allow_staff }}
            <label class="form-check-label" for="{{ form.maintenance_allow_staff.id_for_label }}">Allow staff to use the app during maintenance</label>
          </div>
        </div>
        <div class="col-12">
          <label class="form-label">Message (optional)</label>
          {{ form.maintenance_message }}
        </div>
      </div>

      <hr class="my-4">

      <h2 class="h6">Billing trial (fallback default)</h2>
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-4">
          <label class="form-label">Trial days</label>
          {{ form.billing_trial_days }}
          <div class="text-secondary small mt-1">Used only when a plan catalog entry does not specify trial days.</div>
        </div>
      </div>

      <hr class="my-4">

      <h2 class="h6">Stripe mirror health</h2>
      <div class="text-secondary small mb-2">Controls drift detection for Stripe webhooks/subscription projection.</div>
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-4">
          <label class="form-label">Stale after (hours)</label>
          {{ form.stripe_mirror_stale_after_hours }}
          <div class="text-secondary small mt-1">If no Stripe event updates a subscription within this window, we raise an ops alert.</div>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Alert level</label>
          {{ form.stripe_mirror_stale_alert_level }}
        </div>
      </div>

      <hr class="my-4">

      <h2 class="h6">Tenant risk scoring</h2>
      <div class="text-secondary small mb-2">Controls the risk score shown in the Companies directory (0–100). Use this to tune triage sensitivity.</div>
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-4">
          <label class="form-label">Payment failure window (days)</label>
          {{ form.risk_payment_failed_window_days }}
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Trial ending soon window (days)</label>
          {{ form.risk_trial_ends_within_days }}
        </div>
      </div>

      <div class="row g-2 align-items-end mt-1">
        <div class="col-12 col-md-3">
          <label class="form-label">Past due weight</label>
          {{ form.risk_weight_past_due }}
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Mirror stale weight</label>
          {{ form.risk_weight_mirror_stale }}
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Payment failed weight</label>
          {{ form.risk_weight_payment_failed }}
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Payment failed (sub-only) weight</label>
          {{ form.risk_weight_payment_failed_sub_only }}
        </div>
      </div>

      <div class="row g-2 align-items-end mt-1">
        <div class="col-12 col-md-3">
          <label class="form-label">Canceling weight</label>
          {{ form.risk_weight_canceling }}
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Trial ending soon weight</label>
          {{ form.risk_weight_trial_ends_soon }}
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Medium threshold</label>
          {{ form.risk_level_medium_threshold }}
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">High threshold</label>
          {{ form.risk_level_high_threshold }}
        </div>
      </div>

<hr class="my-4">

      <h2 class="h6">Ops governance</h2>
      <div class="text-secondary small mb-2">Operator safety controls for high-impact actions.</div>
      <div class="row g-2 align-items-end">
        <div class="col-12">
          <div class="form-check">
            {{ form.ops_require_2fa_for_critical_actions }}
            <label class="form-check-label" for="{{ form.ops_require_2fa_for_critical_actions.id_for_label }}">Require 2FA for critical ops actions</label>
          </div>
          <div class="text-secondary small mt-1">When enabled, suspend/reactivate/force logout and Stripe billing actions require a valid 2FA session.</div>
        </div>
        <div class="col-12 mt-2">
          <div class="form-check">
            {{ form.ops_two_person_approval_enabled }}
            <label class="form-check-label" for="{{ form.ops_two_person_approval_enabled.id_for_label }}">Enable two-person approval for Stripe ops actions</label>
          </div>
          <div class="text-secondary small mt-1">When enabled, the requester cannot approve or run their own Stripe action. Use this to enforce separation of duties.</div>
        </div>
      </div>

      <h2 class="h6">Owner notifications</h2>
      <div class="text-secondary small mb-2">High-signal lifecycle emails for the platform operator (separate from Ops Alerts).</div>
      <div class="row g-2 align-items-end">
        <div class="col-12">
          <div class="form-check">
            {{ form.ops_notify_email_enabled }}
            <label class="form-check-label" for="{{ form.ops_notify_email_enabled.id_for_label }}">Enable ops notification emails</label>
          </div>
        </div>
        <div class="col-12">
          <label class="form-label">Recipients</label>
          {{ form.ops_notify_email_recipients }}
          <div class="text-secondary small mt-1">Comma-separated email addresses.</div>
        </div>
        <div class="col-12 col-md-6">
          <div class="form-check">
            {{ form.ops_notify_on_company_signup }}
            <label class="form-check-label" for="{{ form.ops_notify_on_company_signup.id_for_label }}">Notify on new company signup</label>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="form-check">
            {{ form.ops_notify_on_subscription_active }}
            <label class="form-check-label" for="{{ form.ops_notify_on_subscription_active.id_for_label }}">Notify when subscription becomes active</label>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <h2 class="h6">Ops alert routing</h2>
      <div class="text-secondary small mb-2">Controls webhook/email delivery for Ops Alerts (alerts are always stored in the database).</div>

      <div class="row g-2 align-items-end">
        <div class="col-12">
          <div class="form-check">
            {{ form.ops_alert_webhook_enabled }}
            <label class="form-check-label" for="{{ form.ops_alert_webhook_enabled.id_for_label }}">Enable webhook delivery</label>
          </div>
        </div>
        <div class="col-12">
          <label class="form-label">Webhook URL</label>
          {{ form.ops_alert_webhook_url }}
          {% if form.ops_alert_webhook_url.errors %}<div class="text-danger small">{{ form.ops_alert_webhook_url.errors|join:", " }}</div>{% endif %}
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Timeout (seconds)</label>
          {{ form.ops_alert_webhook_timeout_seconds }}
        </div>
      </div>

      <hr class="my-3">

      <div class="row g-2 align-items-end">
        <div class="col-12">
          <div class="form-check">
            {{ form.ops_alert_email_enabled }}
            <label class="form-check-label" for="{{ form.ops_alert_email_enabled.id_for_label }}">Enable email delivery</label>
          </div>
        </div>
        <div class="col-12">
          <label class="form-label">Recipients</label>
          {{ form.ops_alert_email_recipients }}
          <div class="text-secondary small mt-1">Comma-separated email addresses.</div>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Minimum level</label>
          {{ form.ops_alert_email_min_level }}
        </div>
      </div>

      <hr class="my-3">

      <h3 class="h6 mt-3">Noise filters</h3>
      <div class="row g-2">
        <div class="col-12 col-md-6">
          <label class="form-label">Ignore path prefixes</label>
          {{ form.ops_alert_noise_path_prefixes }}
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">Ignore user agent tokens</label>
          {{ form.ops_alert_noise_user_agents }}
        </div>
      </div>

      <div class="row g-2 mt-2">
        <div class="col-12 col-md-4">
          <label class="form-label">Dedup minutes</label>
          {{ form.ops_alert_dedup_minutes }}
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Prune resolved after (days)</label>
          {{ form.ops_alert_prune_resolved_after_days }}
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Prune expired snoozes after (days)</label>
          {{ form.ops_snooze_prune_after_days }}
        </div>
      </div>

    </div>
    <div class="card-footer d-flex align-items-center justify-content-between">
      <div class="text-secondary small">Changes apply immediately.</div>
      <button class="btn btn-ez" type="submit">Save settings</button>
    </div>
  </form>
</div>
{% endblock %}
