{% extends "ops/_base.html" %}

{% block ops_title %}Email Health{% endblock %}

{% block ops_content %}
  <div class="mb-3">
    <h1 class="h4 mb-1">Email Health</h1>
    <div class="ez-ops-muted small">Outbound transactional email deliverability signals (best-effort logging).</div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="text-muted small">Health</div>
              <div class="fs-5 fw-semibold">
                {% if health == 'green' %}
                  <span class="badge text-bg-success">Green</span>
                {% elif health == 'yellow' %}
                  <span class="badge text-bg-warning">Yellow</span>
                {% else %}
                  <span class="badge text-bg-danger">Red</span>
                {% endif %}
              </div>
            </div>
            <div class="text-end">
              <div class="text-muted small">Last error</div>
              <div class="fw-semibold">{% if last_error_at %}{{ last_error_at|date:"M j, Y g:ia" }}{% else %}—{% endif %}</div>
            </div>
          </div>

          {% if last_error_msg %}
            <div class="mt-3 small">
              <div class="text-muted">Last error message (truncated)</div>
              <div class="border rounded p-2 bg-light-subtle">{{ last_error_msg }}</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6 col-md-3">
              <div class="text-muted small">Sent (24h)</div>
              <div class="fs-4 fw-semibold">{{ sent_24h }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">Failures (24h)</div>
              <div class="fs-4 fw-semibold">{{ fail_24h }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">Failure rate (24h)</div>
              <div class="fs-4 fw-semibold">{{ fail_rate_24h_pct|floatformat:2 }}%</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">Failures (7d)</div>
              <div class="fs-4 fw-semibold">{{ fail_7d }}</div>
            </div>
          </div>
          <div class="text-muted small mt-2">Counts are based on app-level logging and do not require provider APIs.</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-transparent">
          <div class="fw-semibold">Top failing templates (7d)</div>
        </div>
        <div class="card-body">
          {% if failures_by_template %}
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th>Template</th>
                    <th class="text-end">Failures</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in failures_by_template %}
                    <tr>
                      <td class="text-truncate" style="max-width: 360px;">{{ row.template_type }}</td>
                      <td class="text-end">{{ row.count }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted">No failures recorded in the last 7 days.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-transparent">
          <div class="fw-semibold">Recent failures (7d)</div>
        </div>
        <div class="card-body">
          {% if recent_failures %}
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>To</th>
                    <th>Company</th>
                    <th>Template</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in recent_failures %}
                    <tr>
                      <td class="text-nowrap">{{ row.created_at|date:"M j, g:ia" }}</td>
                      <td class="text-truncate" style="max-width: 220px;">{{ row.to_email }}</td>
                      <td class="text-truncate" style="max-width: 220px;">{% if row.company %}{{ row.company.name }}{% else %}—{% endif %}</td>
                      <td class="text-truncate" style="max-width: 260px;">{{ row.template_type }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted">No failures in the last 7 days.</div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
{% endblock %}
