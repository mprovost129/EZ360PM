{% extends "base_app.html" %}
{% load static %}
{% block title %}Alert · {{ alert.title }} · EZ360PM{% endblock %}
{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">Alert</h1>
    <div class="text-secondary small">{{ alert.created_at|date:"Y-m-d H:i" }} · {{ alert.get_level_display }} · {{ alert.get_source_display }}</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-dark" href="{% url 'ops:alerts' %}">Back to alerts</a>
    <a class="btn btn-outline-secondary" href="{% url 'ops:alert_details_json' alert.id %}"><i class="bi bi-download me-1"></i>Details JSON</a>
    <div class="dropdown">
      <button class="btn btn-outline-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="bi bi-bell-slash me-1"></i>Snooze
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li class="px-3 py-2 small text-secondary">Suppress new alerts for this source.</li>
        <li><hr class="dropdown-divider"></li>
        <li>
          <form method="post" action="{% url 'ops:alert_snooze' %}" class="px-3 py-1">
            {% csrf_token %}
            <input type="hidden" name="source" value="{{ alert.source }}">
            {% if alert.company %}<input type="hidden" name="company_id" value="{{ alert.company.id }}">{% endif %}
            <input type="hidden" name="minutes" value="60">
            <input type="hidden" name="next" value="{% url 'ops:alert_detail' alert.id %}">
            <button class="btn btn-sm btn-outline-dark w-100" type="submit">Snooze 1 hour{% if alert.company %} (company){% else %} (platform){% endif %}</button>
          </form>
        </li>
        <li>
          <form method="post" action="{% url 'ops:alert_snooze' %}" class="px-3 py-1">
            {% csrf_token %}
            <input type="hidden" name="source" value="{{ alert.source }}">
            {% if alert.company %}<input type="hidden" name="company_id" value="{{ alert.company.id }}">{% endif %}
            <input type="hidden" name="minutes" value="1440">
            <input type="hidden" name="next" value="{% url 'ops:alert_detail' alert.id %}">
            <button class="btn btn-sm btn-outline-dark w-100" type="submit">Snooze 24 hours{% if alert.company %} (company){% else %} (platform){% endif %}</button>
          </form>
        </li>
      </ul>
    </div>
    {% if not alert.is_resolved %}
      <form method="post" action="{% url 'ops:alert_resolve' alert.id %}">
        {% csrf_token %}
        <button class="btn btn-dark" type="submit"><i class="bi bi-check2-circle me-1"></i>Resolve</button>
      </form>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="fw-semibold">{{ alert.title }}</div>
    {% if alert.company %}
      <div class="text-secondary small">Company: <a href="{% url 'ops:company_detail' alert.company.id %}">{{ alert.company.name }}</a></div>
    {% else %}
      <div class="text-secondary small">Company: <span class="text-secondary">Platform</span></div>
    {% endif %}
    {% if alert.message %}
      <div class="mt-3">{{ alert.message|linebreaksbr }}</div>
    {% endif %}

    {% if request_id %}
      <div class="mt-3">
        <div class="fw-semibold">Correlation</div>
        <div class="text-secondary small">Request ID</div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <code class="border rounded px-2 py-1 bg-light">{{ request_id }}</code>
          <button class="btn btn-sm btn-outline-dark" type="button" id="copyRidBtn"><i class="bi bi-clipboard me-1"></i>Copy</button>
          <span class="small text-secondary" id="copyRidStatus" style="display:none;"></span>
        </div>
        <div class="small text-secondary mt-1">Use the Request ID to locate the matching request in your hosting/provider logs.</div>
      </div>
    {% endif %}
    {% if alert.is_resolved %}
      <div class="mt-3">
        <span class="badge text-bg-success">Resolved</span>
        <span class="text-secondary small ms-2">{{ alert.resolved_at|date:"Y-m-d H:i" }}{% if alert.resolved_by_email %} · {{ alert.resolved_by_email }}{% endif %}</span>
      </div>
    {% else %}
      <div class="mt-3"><span class="badge text-bg-warning">Open</span></div>
    {% endif %}

    {% if snooze_until %}
      <div class="mt-2 small text-secondary">
        <i class="bi bi-bell-slash me-1"></i>
        Source snoozed until <span class="fw-semibold">{{ snooze_until|date:"Y-m-d H:i" }}</span>
      </div>
    {% endif %}
  </div>
</div>

{% if alert.details %}
  <div class="card shadow-sm mt-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-semibold">Details (JSON)</div>
        <button class="btn btn-sm btn-outline-dark" type="button" id="copyDetailsBtn"><i class="bi bi-clipboard me-1"></i>Copy JSON</button>
      </div>
      {{ alert.details|json_script:"alert-details-json" }}
      <pre class="mb-0" style="white-space: pre-wrap;" id="detailsPre">{{ alert.details|pprint }}</pre>
      <div class="small text-secondary mt-2" id="copyDetailsStatus" style="display:none;"></div>
    </div>
  </div>
{% endif %}

<script>
  (function() {
    var btn = document.getElementById('copyDetailsBtn');
    if (!btn) return;
    var status = document.getElementById('copyDetailsStatus');
    btn.addEventListener('click', async function() {
      try {
        var script = document.getElementById('alert-details-json');
        var raw = script ? script.textContent : '';
        await navigator.clipboard.writeText(raw || '');
        if (status) {
          status.style.display = 'block';
          status.textContent = 'Copied to clipboard.';
        }
      } catch (e) {
        if (status) {
          status.style.display = 'block';
          status.textContent = 'Copy failed. Select the text and copy manually.';
        }
      }
    });
  })();

  (function() {
    var btn = document.getElementById('copyRidBtn');
    if (!btn) return;
    var status = document.getElementById('copyRidStatus');
    btn.addEventListener('click', async function() {
      try {
        await navigator.clipboard.writeText('{{ request_id|default:"" }}');
        if (status) {
          status.style.display = 'inline';
          status.textContent = 'Copied.';
        }
      } catch (e) {
        if (status) {
          status.style.display = 'inline';
          status.textContent = 'Copy failed.';
        }
      }
    });
  })();
</script>
{% endblock %}
