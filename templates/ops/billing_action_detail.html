{% extends "ops/_base.html" %}

{% block title %}Stripe action · Billing · Ops · EZ360PM{% endblock %}

{% block ops_title %}Stripe Action{% endblock %}
{% block ops_subtitle %}
  <div class="ez-ops-muted small">{{ action.company.name }} · {{ action.get_action_type_display }}</div>
{% endblock %}

{% block ops_actions %}
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-outline-dark ez-ops-btn" href="{% url 'ops:billing_actions' %}"><i class="bi bi-arrow-left me-1"></i>Queue</a>
    <a class="btn btn-outline-dark ez-ops-btn" href="{% url 'ops:company_detail' action.company.id %}?tab=billing"><i class="bi bi-buildings me-1"></i>Company billing</a>
  </div>
{% endblock %}

{% block ops_content %}

<div class="row g-3">
  <div class="col-lg-7">
    <div class="card ez-ops-card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div class="fw-semibold">Action</div>
        <div>
          {% if action.status == 'pending' %}<span class="badge text-bg-warning">Pending</span>{% endif %}
          {% if action.status == 'approved' %}<span class="badge text-bg-info">Approved</span>{% endif %}
          {% if action.status == 'running' %}<span class="badge text-bg-primary">Running</span>{% endif %}
          {% if action.status == 'succeeded' %}<span class="badge text-bg-success">Succeeded</span>{% endif %}
          {% if action.status == 'failed' %}<span class="badge text-bg-danger">Failed</span>{% endif %}
          {% if action.status == 'canceled' %}<span class="badge text-bg-secondary">Canceled</span>{% endif %}
        </div>
      </div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-6">
            <div class="small text-secondary">Company</div>
            <div class="fw-semibold">{{ action.company.name }}</div>
            <div class="text-secondary small">{{ action.company.id }}</div>
          </div>
          <div class="col-md-6">
            <div class="small text-secondary">Action type</div>
            <div class="fw-semibold">{{ action.get_action_type_display }}</div>
          </div>
          <div class="col-md-6">
            <div class="small text-secondary">Requested</div>
            <div class="fw-semibold">{{ action.created_at|date:"Y-m-d H:i" }}</div>
            <div class="text-secondary small">{{ action.requested_by_email|default:"" }}</div>
          </div>
          <div class="col-md-6">
            <div class="small text-secondary">Subscription snapshot</div>
            <div class="fw-semibold">{{ action.subscription_id_snapshot|default:"—" }}</div>
          </div>
        </div>

        {% if action.payload %}
          <hr>
          <div class="small text-secondary">Payload</div>
          <pre class="small mb-0" style="white-space: pre-wrap;">{{ action.payload }}</pre>
        {% endif %}

        {% if action.error %}
          <hr>
          <div class="alert alert-danger mb-0">
            <div class="fw-semibold">Error</div>
            <div class="small" style="white-space: pre-wrap;">{{ action.error }}</div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card ez-ops-card">
      <div class="card-header"><div class="fw-semibold">Controls</div></div>
      <div class="card-body">
        {% if action.requires_approval %}
          <div class="text-secondary small mb-2">This action requires approval before execution.</div>
        {% endif %}

        <div class="vstack gap-2">
          {% if action.status == 'pending' %}
            <form method="post" action="{% url 'ops:billing_action_approve' action.id %}">
              {% csrf_token %}
              <input class="form-control form-control-sm mt-2" name="confirm" placeholder="Type {{ action.company.name }} to confirm" required>
              <button class="btn btn-outline-info w-100" type="submit"><i class="bi bi-check2-circle me-1"></i>Approve</button>
            </form>
          {% endif %}

          {% if action.status == 'approved' or (not action.requires_approval and action.status == 'pending') %}
            <form method="post" action="{% url 'ops:billing_action_run' action.id %}">
              {% csrf_token %}
              <input class="form-control form-control-sm mt-2" name="confirm" placeholder="Type {{ action.company.name }} to confirm" required>
              <button class="btn btn-dark w-100" type="submit"><i class="bi bi-play-fill me-1"></i>Run now</button>
            </form>
          {% endif %}

          {% if action.status == 'pending' or action.status == 'approved' %}
            <form method="post" action="{% url 'ops:billing_action_cancel' action.id %}">
              {% csrf_token %}
              <button class="btn btn-outline-secondary w-100" type="submit"><i class="bi bi-x-circle me-1"></i>Cancel</button>
            </form>
          {% endif %}
        </div>

        <hr>

        <div class="small text-secondary">Approval</div>
        <div class="fw-semibold">{% if action.approved_at %}{{ action.approved_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}</div>
        <div class="text-secondary small">{{ action.approved_by_email|default:"" }}</div>

        <div class="mt-3 small text-secondary">Execution</div>
        <div class="fw-semibold">{% if action.executed_at %}{{ action.executed_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}</div>
        <div class="text-secondary small">{{ action.executed_by_email|default:"" }}</div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
