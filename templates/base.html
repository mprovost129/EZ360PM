{# templates/base.html #}
{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0d6efd" />
    <meta name="color-scheme" content="light dark" />

    <title>{% block head_title %}{{ APP_NAME }}{% endblock %}</title>

    {# Optional SEO blocks so pages can override without touching base #}
    {% block head_meta %}{% endblock %}
    {% block head_canonical %}{% endblock %}
    {% block head_og %}{% endblock %}
    {% block head_jsonld %}{% endblock %}

    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/app.css' %}" />

    {% block head_icons %}{% endblock %}
    {% block head_favicons %}{% endblock %}
    {% block extra_css %}{% endblock %}
  </head>
  <body class="{% block body_class %}{% if request.user.is_authenticated %}app{% else %}public{% endif %}{% endblock %}">
    <a href="#main-content" class="visually-hidden-focusable position-absolute top-0 start-0 m-2 px-3 py-2 bg-light border rounded">
      Skip to content
    </a>

    {# Public navbar only when logged out #}
    {% if not request.user.is_authenticated %}
      {% include "includes/public_nav.html" %}
    {% endif %}

    {# Public-only flash messages (app pages show messages inside the panel) #}
    {% if not request.user.is_authenticated %}
      <div class="container mt-3" aria-live="polite" aria-atomic="true">
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'secondary' }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      </div>
    {% endif %}

    {% block content %}
      {% if request.user.is_authenticated %}
        {# Fixed elements #}
        <aside class="app-sidebar" aria-label="Application sidebar">
          {% include "includes/app_sidebar.html" %}
        </aside>
        <header class="app-topbar" role="banner">
          {% include "includes/app_topbar.html" %}
        </header>

        {# Scrollable main pane (offset by CSS with margin-left/padding-top) #}
        <main id="main-content" class="app-main" role="main">
          <div class="container-fluid">

            {# App flash messages #}
            {% if messages %}
              <div class="mb-3" aria-live="polite" aria-atomic="true">
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags|default:'secondary' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            {% include "_upgrade_banner.html" %}

            <h1 class="h4 mb-3">{% block page_title %}{% endblock %}</h1>
            {% block app_content %}{% endblock %}
          </div>
        </main>

        {# Footer & cookie banner aligned with main (not under the fixed sidebar) #}
        <footer class="app-main-footer" role="contentinfo">
          {% include "dashboard/legal/_cookie_banner.html" %}
          {% include "includes/footer.html" %}
        </footer>

      {% else %}
        {# Public pages keep the simple container layout #}
        <main id="main-content" role="main" class="container py-4">
          {% block public_content %}{% endblock %}
        </main>

        <footer role="contentinfo">
          {% include "dashboard/legal/_cookie_banner.html" %}
          {% include "includes/footer.html" %}
        </footer>
      {% endif %}
    {% endblock %}

    <script src="{% static 'js/bootstrap.bundle.min.js' %}" defer></script>
    {# Load timer JS only for authenticated app pages to avoid null lookups #}
    {% if request.user.is_authenticated %}
      <script src="{% static 'js/timer.js' %}" defer></script>
    {% endif %}

    {# If you later add CSP nonces, expose a block and attach it to inline scripts #}
    <script>
      document.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
          const inp = document.querySelector('form[role="search"] input[type="search"]');
          if (inp) {
            e.preventDefault();
            inp.focus();
            try { inp.select(); } catch(_) {}
          }
        }
      });
    </script>

    {% block body_portal %}{% endblock %}
    {% block extra_js %}{% endblock %}
  </body>
</html>
