{% extends "base_app.html" %}
{% load static %}
{% load dict_extras %}

{% block title %}Team · EZ360PM{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1100px;">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h3 mb-0">Team</h1>
      <div class="text-secondary small">Employees under {{ company.name }}.</div>
      {% if subscription_summary %}
        <div class="small mt-1">
          <span class="text-secondary">Seats:</span>
          <strong>{{ subscription_summary.seats_used }}</strong>/<strong>{{ subscription_summary.seats_limit }}</strong>
          {% if not can_add_seat %}
            <span class="badge text-bg-warning ms-2">Seat limit reached</span>
          {% endif %}
        </div>
      {% endif %}
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'companies:settings' %}">
        <i class="bi bi-gear me-1"></i>Company settings
      </a>
      {% if is_admin or is_owner %}
        <a class="btn btn-ez" href="{% url 'companies:invite_create' %}">
          <i class="bi bi-person-plus me-1"></i>Invite employee
        </a>
      {% endif %}
    </div>
  </div>

  {% if invites %}
    <div class="card shadow-sm mb-3">
      <div class="card-body p-0">
        <div class="p-3 border-bottom">
          <div class="fw-semibold">Pending invites</div>
          <div class="text-secondary small">Invitations that haven’t been accepted yet.</div>
        </div>
        <div class="table-responsive">
          <table class="table mb-0 align-middle">
            <thead>
              <tr>
                <th>Email</th>
                <th>Username</th>
                <th>Role</th>
                <th>Expires</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for inv in invites %}
                <tr>
                  <td class="fw-semibold">{{ inv.email }}</td>
                  <td>{{ inv.username_public }}</td>
                  <td><span class="badge text-bg-light">{{ inv.get_role_display }}</span></td>
                  <td>
                    {% if inv.expires_at %}
                      {{ inv.expires_at|date:"Y-m-d" }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <form class="d-inline" method="post" action="{% url 'companies:invite_resend' inv.id %}">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-outline-secondary" type="submit">Resend</button>
                    </form>
                    <form class="d-inline" method="post" action="{% url 'companies:invite_revoke' inv.id %}">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-outline-danger" type="submit">Revoke</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="p-3 border-bottom">
        <div class="fw-semibold">Employees</div>
        <div class="text-secondary small">Manage roles and security posture.</div>
      </div>

      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Username</th>
              <th>Role</th>
              <th>Login lockout</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for e in employees %}
              {% with key=e.user.email|lower %}
                {% with st=lockouts|get_item:key %}
                <tr>
                  <td class="fw-semibold">{{ e.display_name|default:e.username_public }}</td>
                  <td>{{ e.user.email }}</td>
                  <td>{{ e.username_public }}</td>
                  <td><span class="badge text-bg-light">{{ e.get_role_display }}</span></td>
                  <td>
                    {% if st and st.is_locked %}
                      <span class="badge text-bg-danger">Locked</span>
                      {% if st.locked_until %}
                        <span class="text-secondary small ms-1">until {{ st.locked_until|date:"H:i" }}</span>
                      {% endif %}
                    {% else %}
                      <span class="badge text-bg-success">OK</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if is_admin or is_owner %}
                      {% if st and st.is_locked %}
                      <form method="post" action="{% url 'companies:employee_unlock' e.id %}" class="d-inline">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-outline-danger" type="submit">Unlock</button>
                      </form>
                    {% else %}
                      <span class="text-secondary small">—</span>
                      {% endif %}
                    {% endif %}
                  </td>
                </tr>
                {% endwith %}
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="p-3 border-top">
        <div class="text-secondary small">
          Lockouts are account-based and automatically clear on successful login. Admins can unlock users here if needed.
        </div>
      </div>
    </div>
  </div>
</div>

{% include "includes/pagination.html" %}
{% endblock %}