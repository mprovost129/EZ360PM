{% load static %}
{# templates/includes/app_topbar.html #}
<header class="app-topbar px-3 py-2 d-flex align-items-center justify-content-between"
        role="banner" aria-label="Topbar">

  <div class="d-flex align-items-center gap-2">
    <form class="d-flex me-2" method="get" action="{% url 'core:search' %}"
          role="search" aria-label="Quick search" autocomplete="off">
      <input class="form-control form-control-sm" type="search" name="q"
             value="{{ request.GET.q|default_if_none:'' }}"
             placeholder="Search…" aria-label="Search">
    </form>
  </div>

  <div class="d-flex align-items-center gap-2">

    {# Timer widget wrapper passes endpoints to timer.js via data-* #}
    <div id="timerWidget"
         data-url-status="{% url 'timetracking:timer_status' %}"
         data-url-start="{% url 'timetracking:timer_start' %}"
         data-url-stop="{% url 'timetracking:timer_stop' %}"
         data-url-save="{% url 'timetracking:timer_save' %}"
         data-url-del-template="{% url 'timetracking:timer_delete' pk='__id__' %}"
         data-csrf-token="{{ csrf_token }}">
      <div class="dropdown nav-item">
        <a class="nav-link dropdown-toggle d-flex align-items-center"
          href="#" id="timerDropdown"
          data-bs-toggle="dropdown" data-bs-auto-close="outside"
          aria-expanded="false" aria-haspopup="true" aria-controls="timerMenu">
          <img src="{% static 'icons/bootstrap-icons/stopwatch.svg' %}"
                class="me-1" width="16" height="16" alt="" aria-hidden="true">
          <span id="timerLabel">Timer</span>
          <span id="timerDot" class="badge bg-success rounded-pill ms-1 d-none" aria-hidden="true">●</span>
          <span class="visually-hidden" id="timerSR" aria-live="polite"></span>
        </a>

        <div id="timerMenu" class="dropdown-menu dropdown-menu-end p-3" style="min-width: 320px;">
          <div id="timerRunning" class="d-none">
            <div class="fw-semibold" id="timerProjectName"></div>
            <div class="text-muted small">Elapsed: <span id="elapsedText">00:00:00</span></div>
            <label for="timerNotes" class="visually-hidden">Work notes</label>
            <textarea id="timerNotes" class="form-control mt-2" rows="2" placeholder="What did you work on?"></textarea>
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-primary btn-sm" id="btnStopSave" type="button">Stop &amp; Save</button>
              <button class="btn btn-outline-secondary btn-sm" id="btnSaveNotes" type="button">Save notes</button>
              <button class="btn btn-outline-danger btn-sm ms-auto" id="btnDelete" type="button">Delete</button>
            </div>
          </div>

          <div id="timerIdle">
            <label class="form-label" for="timerProject">Start timer</label>
            <select id="timerProject" class="form-select form-select-sm" aria-label="Select a project to start timer">
              <option value="">— Select a project —</option>
              {% for p in timer_projects %}
                <option value="{{ p.id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
            <label for="timerNotesIdle" class="visually-hidden">Notes (optional)</label>
            <textarea id="timerNotesIdle" class="form-control mt-2" rows="2" placeholder="Optional: notes"></textarea>
            <button class="btn btn-primary btn-sm w-100 mt-2" id="btnStart" type="button">Start</button>
          </div>

          <div class="mt-2 text-end">
            <a href="{% url 'timetracking:time_list' %}" class="small">View all time</a>
          </div>
        </div>
      </div>
    </div>

    {# New button #}
    <div class="dropdown">
      <button class="shadow btn btn-sm btn-success dropdown-toggle d-flex align-items-center"
              data-bs-toggle="dropdown" aria-expanded="false" aria-label="Create new">
        <img src="{% static 'icons/bootstrap-icons/plus-lg.svg' %}" class="icon me-1" alt="" aria-hidden="true">
        <span class="d-none d-sm-inline">New</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li class="dropdown-header">Create</li>

        <li>
          <a class="dropdown-item" href="{% url 'clients:client_create' %}">
            <img src="{% static 'icons/bootstrap-icons/person-plus.svg' %}" class="icon me-2" alt="" aria-hidden="true">
            Client
          </a>
        </li>

        <li>
          <a class="dropdown-item" href="{% url 'projects:project_create_hourly' %}">
            <img src="{% static 'icons/bootstrap-icons/briefcase.svg' %}" class="icon me-2" alt="" aria-hidden="true">
            Project (hourly)
          </a>
        </li>

        <li>
          <a class="dropdown-item" href="{% url 'projects:project_create_flat' %}">
            <img src="{% static 'icons/bootstrap-icons/briefcase-fill.svg' %}" class="icon me-2" alt="" aria-hidden="true">
            Project (flat rate)
          </a>
        </li>

        <li>
          <a class="dropdown-item" href="{% url 'invoices:invoice_create' %}">
            <img src="{% static 'icons/bootstrap-icons/receipt.svg' %}" class="icon me-2" alt="" aria-hidden="true">
            Invoice
          </a>
        </li>

        <li>
          <a class="dropdown-item" href="{% url 'expenses:expense_create' %}">
            <img src="{% static 'icons/bootstrap-icons/cash-stack.svg' %}" class="icon me-2" alt="" aria-hidden="true">
            Expense
          </a>
        </li>
      </ul>
    </div>

    {# Notifications #}
    <a class="shadow btn btn-sm btn-outline-secondary position-relative"
       href="{% url 'core:notifications' %}"
       title="Notifications" aria-label="Notifications">
      <span class="d-inline-block" style="line-height:1">
        <img src="{% static 'icons/bootstrap-icons/bell.svg' %}" class="icon" alt="" aria-hidden="true">
      </span>
      {% if unread_notifications_count %}
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              aria-live="polite" aria-atomic="true">
          {{ unread_notifications_count }}
          <span class="visually-hidden">unread notifications</span>
        </span>
      {% endif %}
    </a>

    <a class="shadow btn btn-sm btn-outline-secondary" href="{% url 'dashboard:help_index' %}">Help</a>
    <a class="shadow btn btn-sm btn-outline-secondary" href="{% url 'dashboard:contact' %}">Contact</a>

    <div class="dropdown">
      <button class="shadow btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
        Profile
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="{% url 'accounts:my_profile' %}">User profile</a></li>
        <li><a class="dropdown-item" href="{% url 'accounts:password_change' %}">Change password</a></li>
        <li><a class="dropdown-item" href="{% url 'billing:plans' %}">Billing &amp; Upgrade</a></li>
        <li><a class="dropdown-item" href="{% url 'dashboard:refer' %}">Refer a Friend</a></li>
        <li><hr class="dropdown-divider" /></li>
        <li><a class="dropdown-item" href="{% url 'accounts:logout' %}">Log out</a></li>
      </ul>
    </div>
  </div>
</header>
