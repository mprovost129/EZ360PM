{% load static %}

{# templates/includes/app_sidebar.html #}
<div class="app-sidebar">
  <div class="sidebar-company" role="region" aria-label="Company switcher">
    <a href="{% url 'company:company_profile' %}"
       class="d-flex align-items-center gap-2 text-decoration-none w-100"
       title="{{ active_company.name|default:'Company profile' }}">
      {# Prefer company.logo, fall back to company_company_logo for older schemas #}
      {% if active_company and active_company.logo %}
        <img class="brand-logo" src="{{ active_company.logo.url }}" alt="{{ active_company.name }}" />
        <span class="visually-hidden">{{ active_company.name }}</span>
      {% elif active_company and active_company.company_logo %}
        <img class="brand-logo" src="{{ active_company.company_logo.url }}" alt="{{ active_company.name }}" />
        <span class="visually-hidden">{{ active_company.name }}</span>
      {% elif active_company %}
        <span class="brand-name text-truncate">{{ active_company.name }}</span>
      {% else %}
        <span class="brand-name text-truncate">Your Company</span>
      {% endif %}
      <span class="ms-auto">
        <span class="shadow btn btn-sm btn-outline-secondary">Profile</span>
      </span>
    </a>
  </div>

  <nav class="list-group list-group-flush app-sidebar-nav">
    {% with urlname=request.resolver_match.url_name|default:'' viewname=request.resolver_match.view_name|default:'' %}

      <a class="list-group-item list-group-item-action d-flex align-items-center {% if viewname == 'dashboard:home' %}active{% endif %}"
         href="{% url 'dashboard:home' %}"
         {% if viewname == 'dashboard:home' %}aria-current="page"{% endif %}>
        <img class="bi-svg me-2" src="{% static 'icons/bootstrap-icons/speedometer2.svg' %}" alt="" width="16" height="16" aria-hidden="true">
        <span>Dashboard</span>
      </a>

      <a class="list-group-item list-group-item-action d-flex align-items-center {% if urlname == 'clients' %}active{% endif %}"
         href="{% url 'clients:clients' %}"
         {% if urlname == 'clients' %}aria-current="page"{% endif %}>
        <img class="bi-svg me-2" src="{% static 'icons/bootstrap-icons/people.svg' %}" alt="" width="16" height="16" aria-hidden="true">
        <span>Clients</span>
      </a>

      <a class="list-group-item list-group-item-action d-flex align-items-center {% if urlname == 'projects' %}active{% endif %}"
         href="{% url 'projects:projects' %}"
         {% if urlname == 'projects' %}aria-current="page"{% endif %}>
        <img class="bi-svg me-2" src="{% static 'icons/bootstrap-icons/briefcase.svg' %}" alt="" width="16" height="16" aria-hidden="true">
        <span>Projects</span>
      </a>

      {# --- Invoices (collapsible) --- #}
      {% with invoices_set='|invoices|invoice_detail|invoice_create|invoice_update|invoice_refund|payments|payment_create|webhook_logs|' %}
        {% with token='|'|add:urlname|add:'|' %}
          <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                  type="button" data-bs-toggle="collapse" data-bs-target="#navInvoices"
                  aria-controls="navInvoices"
                  aria-expanded="{% if token in invoices_set %}true{% else %}false{% endif %}">
            <span class="d-flex align-items-center">
              <img class="bi-svg me-2" src="{% static 'icons/bootstrap-icons/receipt.svg' %}" alt="" width="16" height="16" aria-hidden="true">
              <span>Invoices</span>
            </span>
            <img class="icon" src="{% static 'icons/bootstrap-icons/chevron-down.svg' %}" width="16" height="16" alt="" aria-hidden="true"
                 style="transition:transform .2s; {% if token in invoices_set %}transform:rotate(180deg);{% endif %}">
          </button>

          <div id="navInvoices" class="collapse {% if token in invoices_set %}show{% endif %}">
            <a class="list-group-item list-group-item-action ps-5 {% if urlname == 'invoices' %}active{% endif %}"
               href="{% url 'invoices:invoices' %}"
               {% if urlname == 'invoices' %}aria-current="page"{% endif %}>
              All invoices
            </a>
            <a class="list-group-item list-group-item-action ps-5 {% if urlname == 'payments' or urlname == 'payment_create' %}active{% endif %}"
               href="{% url 'payments:payments' %}"
               {% if urlname == 'payments' or urlname == 'payment_create' %}aria-current="page"{% endif %}>
              Payments
            </a>
            {% if request.user.is_staff %}
              <a class="list-group-item list-group-item-action ps-5 {% if urlname == 'webhook_logs' %}active{% endif %}"
                 href="{% url 'billing:webhook_logs' %}"
                 {% if urlname == 'webhook_logs' %}aria-current="page"{% endif %}>
                Stripe webhook logs
              </a>
            {% endif %}
          </div>
        {% endwith %}
      {% endwith %}

      <a class="list-group-item list-group-item-action d-flex align-items-center {% if urlname == 'expenses' %}active{% endif %}"
         href="{% url 'expenses:expenses' %}"
         {% if urlname == 'expenses' %}aria-current="page"{% endif %}>
        <img class="bi-svg me-2" src="{% static 'icons/bootstrap-icons/cash-stack.svg' %}" alt="" width="16" height="16" aria-hidden="true">
        <span>Expenses</span>
      </a>

      {# --- Time (collapsible) --- #}
      {% with time_set='|time_list|timesheet_week|approvals_list|' %}
        {% with token='|'|add:urlname|add:'|' %}
          <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                  type="button" data-bs-toggle="collapse" data-bs-target="#navTime"
                  aria-controls="navTime"
                  aria-expanded="{% if token in time_set %}true{% else %}false{% endif %}">
            <span class="d-flex align-items-center">
              <img class="bi-svg me-2" src="{% static 'icons/bootstrap-icons/stopwatch.svg' %}" alt="" width="16" height="16" aria-hidden="true">
              <span>Time</span>
            </span>
            <img class="icon" src="{% static 'icons/bootstrap-icons/chevron-down.svg' %}" width="16" height="16" alt="" aria-hidden="true"
                 style="transition:transform .2s; {% if token in time_set %}transform:rotate(180deg);{% endif %}">
          </button>

          <div id="navTime" class="collapse {% if token in time_set %}show{% endif %}">
            <a class="list-group-item list-group-item-action ps-5 {% if urlname == 'time_list' %}active{% endif %}"
               href="{% url 'timetracking:time_list' %}"
               {% if urlname == 'time_list' %}aria-current="page"{% endif %}>
              Overview
            </a>
            <a class="list-group-item list-group-item-action ps-5 {% if urlname == 'timesheet_week' %}active{% endif %}"
               href="{% url 'timetracking:timesheet_week' %}"
               {% if urlname == 'timesheet_week' %}aria-current="page"{% endif %}>
              Timesheet â€” weekly
            </a>
            {% if active_company and request.user.id == active_company.owner_id %}
              <a class="list-group-item list-group-item-action ps-5 {% if urlname == 'approvals_list' %}active{% endif %}"
                 href="{% url 'timetracking:approvals_list' %}"
                 {% if urlname == 'approvals_list' %}aria-current="page"{% endif %}>
                Approvals
              </a>
            {% endif %}
          </div>
        {% endwith %}
      {% endwith %}

      <a class="list-group-item list-group-item-action d-flex align-items-center {% if urlname == 'reports' %}active{% endif %}"
         href="{% url 'core:reports' %}"
         {% if urlname == 'reports' %}aria-current="page"{% endif %}>
        <img class="bi-svg me-2" src="{% static 'icons/bootstrap-icons/graph-up.svg' %}" alt="" width="16" height="16" aria-hidden="true">
        <span>Reports</span>
      </a>

    {% endwith %}
  </nav>
</div>
