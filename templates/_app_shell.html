{% extends "base.html" %}
{% include "_upgrade_banner.html" %}
{% block content %}
<div class="d-flex">
  <!-- Sidebar -->
  <aside class="app-sidebar border-end">
    <div class="px-3 py-3 border-bottom">
      <a href="{% url 'core:company_profile' %}"
         class="d-flex align-items-center gap-2 text-decoration-none" title="{{ active_company.name }}">
        {% if active_company and active_company.logo %}
          <img src="{{ active_company.logo.url }}" alt="{{ active_company.name }}" style="height:32px;width:auto;">
          <span class="visually-hidden">{{ active_company.name }}</span>
        {% elif active_company %}
          <span class="fw-semibold text-truncate" style="max-width:170px;min-width:0;">
            {{ active_company.name }}
          </span>
        {% else %}
          <span class="fw-semibold text-truncate" style="max-width:170px;min-width:0;">Your Company</span>
        {% endif %}
        <span class="ms-auto">
          <span class="btn btn-sm btn-outline-secondary">Profile</span>
        </span>
      </a>
    </div>

    <nav class="list-group list-group-flush">
      <a class="list-group-item list-group-item-action" href="/">Dashboard</a>

      {# Notifications link with count #}
      <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
         href="{% url 'core:notifications' %}">
        <span>Notifications</span>
        {% if unread_notifications_count %}
          <span class="badge rounded-pill bg-danger">{{ unread_notifications_count }}</span>
        {% endif %}
      </a>

      <a class="list-group-item list-group-item-action" href="{% url 'core:clients' %}">Clients</a>
      <a class="list-group-item list-group-item-action" href="{% url 'core:projects' %}">Projects</a>

      {% with urlname=request.resolver_match.url_name|default:'' %}
        {# --- INVOICES: collapsible pulldown --- #}
        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navInvoices"
                aria-controls="navInvoices"
                aria-expanded="{% if urlname == 'invoices' or urlname == 'invoice_detail' or urlname == 'invoice_create' or urlname == 'invoice_update' or urlname == 'invoice_refund' or urlname == 'payments' or urlname == 'payment_create' or urlname == 'webhook_logs' %}true{% else %}false{% endif %}">
          <span>Invoices</span>
          <span class="small">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"
                 style="transition:transform .2s; {% if urlname == 'invoices' or urlname == 'invoice_detail' or urlname == 'invoice_create' or urlname == 'invoice_update' or urlname == 'invoice_refund' or urlname == 'payments' or urlname == 'payment_create' or urlname == 'webhook_logs' %}transform:rotate(180deg);{% endif %}">
              <path fill-rule="evenodd" d="M1.646 6.646a.5.5 0 0 1 .708 0L8 12.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/>
            </svg>
          </span>
        </button>
        <div id="navInvoices" class="collapse {% if urlname == 'invoices' or urlname == 'invoice_detail' or urlname == 'invoice_create' or urlname == 'invoice_update' or urlname == 'invoice_refund' or urlname == 'payments' or urlname == 'payment_create' or urlname == 'webhook_logs' %}show{% endif %}">
          <a class="list-group-item list-group-item-action ps-5 {% if urlname == 'invoices' %}active{% endif %}"
             href="{% url 'core:invoices' %}">All invoices</a>
          <a class="list-group-item list-group-item-action ps-5 {% if urlname == 'payments' or urlname == 'payment_create' %}active{% endif %}"
             href="{% url 'core:payments' %}">Payments</a>
          {% if request.user.is_staff %}
            <a class="list-group-item list-group-item-action ps-5 {% if urlname == 'webhook_logs' %}active{% endif %}"
               href="{% url 'billing:webhook_logs' %}">Stripe webhook logs</a>
          {% endif %}
        </div>

        <a class="list-group-item list-group-item-action" href="{% url 'core:expenses' %}">Expenses</a>

        {# --- TIME: collapsible pulldown --- #}
        <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navTime"
                aria-controls="navTime"
                aria-expanded="{% if urlname == 'time_list' or urlname == 'timesheet_week' or urlname == 'approvals_list' %}true{% else %}false{% endif %}">
          <span>Time</span>
          <span class="small">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"
                 style="transition:transform .2s; {% if urlname == 'time_list' or urlname == 'timesheet_week' or urlname == 'approvals_list' %}transform:rotate(180deg);{% endif %}">
              <path fill-rule="evenodd" d="M1.646 6.646a.5.5 0 0 1 .708 0L8 12.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/>
            </svg>
          </span>
        </button>
        <div id="navTime" class="collapse {% if urlname == 'time_list' or urlname == 'timesheet_week' or urlname == 'approvals_list' %}show{% endif %}">
          <a class="list-group-item list-group-item-action ps-5 {% if urlname == 'time_list' %}active{% endif %}"
             href="{% url 'core:time_list' %}">Overview</a>
          <a class="list-group-item list-group-item-action ps-5 {% if urlname == 'timesheet_week' %}active{% endif %}"
             href="{% url 'core:timesheet_week' %}">Timesheet — weekly</a>
          {% if active_company and request.user.id == active_company.owner_id %}
            <a class="list-group-item list-group-item-action ps-5 {% if urlname == 'approvals_list' %}active{% endif %}"
               href="{% url 'core:approvals_list' %}">Approvals</a>
          {% endif %}
        </div>
      {% endwith %}

      <a class="list-group-item list-group-item-action" href="/app/reports/">Reports</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-grow-1">
    <!-- Topbar -->
    <header class="app-topbar border-bottom px-3 py-2 d-flex align-items-center justify-content-between">
      <form class="d-flex me-2" method="get" action="{% url 'core:search' %}" role="search">
        <input class="form-control form-control-sm" type="search" name="q" placeholder="Search…" aria-label="Search">
      </form>
      <div class="d-flex align-items-center gap-2">

        {# Bell with unread badge #}
        <a class="btn btn-sm btn-outline-secondary position-relative"
           href="{% url 'core:notifications' %}"
           title="Notifications" aria-label="Notifications">
          <span class="d-inline-block" style="line-height:1">
            <i class="bi bi-bell"></i>
          </span>
          {% if unread_notifications_count %}
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
              {{ unread_notifications_count }}
              <span class="visually-hidden">unread notifications</span>
            </span>
          {% endif %}
        </a>

        <a class="btn btn-sm btn-outline-secondary" href="{% url 'dashboard:help_index' %}">Help</a>
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'dashboard:contact' %}">Contact</a>
        <div class="dropdown">
          <button class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown">
            Profile
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{% url 'core:my_profile' %}">User profile</a></li>
            <li><a class="dropdown-item" href="{% url 'accounts:password_change' %}">Change password</a></li>
            <li><a class="dropdown-item" href="#">Billing & Upgrade</a></li>
            <li><a class="dropdown-item" href="#">Refer a Friend</a></li>
            <li><hr class="dropdown-divider" /></li>
            <li><a class="dropdown-item" href="{% url 'accounts:logout' %}">Log out</a></li>
          </ul>
        </div>
      </div>
    </header>

    <section class="p-3">
      <div class="container-fluid">
        <h1 class="h4 mb-3">{% block page_title %}{% endblock %}</h1>
        {% if messages %}
          <div class="mb-3">
            {% for m in messages %}
              <div class="alert alert-{{ m.tags|default:'info' }}" role="alert">
                {{ m }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
        {% block app_content %}{% endblock %}
      </div>
    </section>
  </main>
</div>
{% endblock %}
