{% extends "base_app.html" %}
{% block title %}QA Issue · Ops · EZ360PM{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 980px;">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1">QA Issue</h1>
      <div class="text-secondary small">Staff-only. Use this to track V1 QA findings.</div>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'ops:qa_issues' %}"><i class="bi bi-arrow-left me-1"></i>Back</a>
      <a class="btn btn-outline-dark" href="{% url 'ops:qa_issue_edit' issue.pk %}"><i class="bi bi-pencil me-1"></i>Edit</a>
      {% if issue.status != 'resolved' and issue.status != 'wont_fix' %}
        <button class="btn btn-dark" type="button" data-bs-toggle="collapse" data-bs-target="#closePanel" aria-expanded="false">
          <i class="bi bi-check2-circle me-1"></i>Close
        </button>
      {% endif %}
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex flex-wrap align-items-start justify-content-between gap-2">
        <div>
          <div class="d-flex flex-wrap gap-2 mb-2">
            <span class="badge text-bg-secondary">{{ issue.get_status_display }}</span>
            {% if issue.severity == 'critical' %}
              <span class="badge text-bg-danger">Critical</span>
            {% elif issue.severity == 'high' %}
              <span class="badge text-bg-warning">High</span>
            {% elif issue.severity == 'medium' %}
              <span class="badge text-bg-info">Medium</span>
            {% else %}
              <span class="badge text-bg-light text-dark">Low</span>
            {% endif %}
            {% if issue.area %}<span class="badge text-bg-light text-dark">{{ issue.area }}</span>{% endif %}
            {% if issue.company %}<span class="badge text-bg-light text-dark">{{ issue.company.name }}</span>{% endif %}
          </div>
          <h2 class="h5 mb-1">{{ issue.title }}</h2>
          {% if issue.description %}<div class="text-secondary">{{ issue.description|linebreaksbr }}</div>{% endif %}
        </div>
        <div class="text-end text-secondary small">
          <div>Created: {{ issue.created_at|date:"Y-m-d H:i" }}</div>
          <div>Updated: {{ issue.updated_at|date:"Y-m-d H:i" }}</div>
          {% if issue.resolved_at %}<div>Resolved: {{ issue.resolved_at|date:"Y-m-d H:i" }}</div>{% endif %}
        </div>
      </div>
    </div>
  </div>

  {% if issue.status != 'resolved' and issue.status != 'wont_fix' %}
    <div class="collapse mb-3" id="closePanel">
      <div class="card shadow-sm">
        <div class="card-body">
          <form method="post" action="{% url 'ops:qa_issue_close' issue.pk %}">
            {% csrf_token %}
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">Outcome</label>
                <select class="form-select" name="outcome">
                  <option value="resolved">Resolved</option>
                  <option value="wont_fix">Won't fix</option>
                </select>
              </div>
              <div class="col-md-9">
                <label class="form-label">Notes (optional)</label>
                <input class="form-control" name="notes" placeholder="What changed / why it’s closed…">
              </div>
              <div class="col-12 d-flex gap-2">
                <button class="btn btn-dark" type="submit">Close issue</button>
                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#closePanel">Cancel</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="row g-3">
        {% if issue.related_url %}
          <div class="col-12">
            <div class="text-secondary small">Related URL</div>
            <div><a href="{{ issue.related_url }}" target="_blank" rel="noopener">{{ issue.related_url }}</a></div>
          </div>
        {% endif %}

        {% if issue.steps_to_reproduce %}
          <div class="col-12">
            <div class="text-secondary small">Steps to reproduce</div>
            <div>{{ issue.steps_to_reproduce|linebreaksbr }}</div>
          </div>
        {% endif %}

        {% if issue.expected_behavior or issue.actual_behavior %}
          <div class="col-md-6">
            <div class="text-secondary small">Expected behavior</div>
            <div>{{ issue.expected_behavior|default:"—"|linebreaksbr }}</div>
          </div>
          <div class="col-md-6">
            <div class="text-secondary small">Actual behavior</div>
            <div>{{ issue.actual_behavior|default:"—"|linebreaksbr }}</div>
          </div>
        {% endif %}

        <div class="col-md-6">
          <div class="text-secondary small">Discovered by</div>
          <div>{{ issue.discovered_by_email|default:"—" }}</div>
        </div>
        <div class="col-md-6">
          <div class="text-secondary small">Assigned to</div>
          <div>{{ issue.assigned_to_email|default:"—" }}</div>
        </div>

        {% if issue.resolution_notes %}
          <div class="col-12">
            <div class="text-secondary small">Resolution notes</div>
            <div>{{ issue.resolution_notes|linebreaksbr }}</div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
