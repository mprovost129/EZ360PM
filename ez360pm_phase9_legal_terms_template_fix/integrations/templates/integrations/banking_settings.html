{% extends "base_app.html" %}
{% block title %}Bank feeds · EZ360PM{% endblock %}


{% block extra_js %}
{% if bank_enabled and bank_configured %}
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
(function() {
  const btn = document.getElementById("plaid-connect-btn");
  if (!btn) return;

  function getCookie(name) {
    const v = document.cookie.match('(^|;)\s*' + name + '\s*=\s*([^;]+)');
    return v ? v.pop() : '';
  }

  async function postForm(url, data) {
    const body = new URLSearchParams(data);
    const resp = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: body
    });
    return resp;
  }

  btn.addEventListener("click", async function() {
    btn.disabled = true;
    btn.classList.add("disabled");
    try {
      // 1) Get link token
      const resp = await postForm("{% url 'integrations:banking_link_token' %}", {});
      const payload = await resp.json();
      if (!payload.ok) throw new Error(payload.error || "Unable to create link token.");

      // 2) Launch Plaid Link
      const handler = Plaid.create({
        token: payload.link_token,
        onSuccess: async function(public_token, metadata) {
          const exResp = await postForm("{% url 'integrations:banking_exchange' %}", { public_token: public_token });
          const ex = await exResp.json();
          if (!ex.ok) throw new Error(ex.error || "Unable to exchange token.");
          window.location.reload();
        },
        onExit: function(err, metadata) {
          if (err) console.warn(err);
          btn.disabled = false;
          btn.classList.remove("disabled");
        }
      });
      handler.open();
    } catch (e) {
      alert(e.message || String(e));
      btn.disabled = false;
      btn.classList.remove("disabled");
    }
  });
})();
</script>
{% endif %}
{% endblock %}


{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">Bank feeds (expenses import)</h1>
    <div class="text-secondary small">
      Connect a bank account to import transactions and turn them into Expenses.
    </div>
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'companies:settings' %}">
    <i class="bi bi-gear me-1"></i>Company settings
  </a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="mb-3">
      <div class="small text-secondary">Active company</div>
      <div class="fw-semibold">{{ company.name }}</div>
    </div>

    {% if not bank_enabled %}
      <div class="alert alert-secondary mb-3">
        Bank feeds are currently disabled.
        <div class="small text-secondary mt-1">
          Set <code>PLAID_ENABLED=true</code> to enable the integration.
        </div>
      </div>
    {% endif %}

    {% if bank_enabled and not bank_configured %}
      <div class="alert alert-warning mb-3">
        Bank feeds are not configured yet.
        <div class="small text-secondary mt-1">
          Add <code>PLAID_CLIENT_ID</code> and <code>PLAID_SECRET</code> to your environment.
        </div>
      </div>
    {% endif %}

    <div class="alert alert-info mb-3">
      <div class="fw-semibold mb-1"><i class="bi bi-info-circle me-1"></i>Plaid verification</div>
      <div class="small text-secondary">
        Plaid may require business verification to enable <code>production</code> keys. This integration is
        feature-flagged and safe to ship disabled. When you are ready, start with <code>PLAID_ENV=sandbox</code>
        and swap to <code>production</code> once Plaid approves your account.
      </div>
    </div>

    {% if conn and conn.is_active %}
      <div class="alert alert-success d-flex align-items-start justify-content-between gap-3">
        <div>
          <div class="fw-semibold mb-1"><i class="bi bi-check-circle me-1"></i>Connected</div>
          <div class="small text-secondary">
            Provider: <code>{{ conn.provider }}</code><br>
            Last sync: {{ conn.last_sync_at|default:"(never)" }}
          </div>
          {% if conn.last_sync_error %}
            <div class="small text-danger mt-2">{{ conn.last_sync_error }}</div>
          {% endif %}
          <div class="small text-secondary mt-2">
            Note: Transactions import is enabled. Use “Sync transactions” to pull the latest activity.
          </div>
        </div>

        <form method="post" action="{% url 'integrations:banking_disconnect' %}">
          {% csrf_token %}
          <button class="btn btn-outline-danger" type="submit">
            <i class="bi bi-x-circle me-1"></i>Disconnect
          </button>
        </form>
      </div>
    {% else %}
      <p class="text-secondary mb-3">
        Not connected yet. Connect your bank to import transactions and quickly create categorized expenses.
      </p>
      <button class="btn btn-dark {% if not bank_enabled or not bank_configured %}disabled{% endif %}" type="button" id="plaid-connect-btn">
        <i class="bi bi-link-45deg me-1"></i>Connect bank account
      </button>
      <div class="small text-secondary mt-2">
        You will be redirected through Plaid Link. Your access token is stored in the database (recommended to enable DB encryption-at-rest).
      </div>
    {% endif %}

    <hr>

    <div class="small text-secondary">
      <div class="fw-semibold text-dark mb-1">What this enables (next packs)</div>
      <ul class="mb-0">
        <li>Secure bank linking (Plaid Link) + token exchange</li>
        <li>Transaction sync by date window + de-duplication</li>
        <li>Rules: map merchant/category → expense account</li>
        <li>“Create expense” action from imported transactions</li>
      </ul>
    </div>
  
{% if conn and conn.is_active %}
  <div class="card shadow-sm mt-3">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
          <div class="fw-semibold">Accounts</div>
          <div class="small text-secondary">Imported from Plaid</div>
        </div>
        <form method="post" action="{% url 'integrations:banking_sync' %}">
          {% csrf_token %}
          <button class="btn btn-outline-primary" type="submit">
            <i class="bi bi-arrow-repeat me-1"></i>Sync transactions
          </button>
        </form>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Account</th>
              <th class="text-muted">Type</th>
              <th class="text-end">Currency</th>
            </tr>
          </thead>
          <tbody>
            {% for a in conn.accounts.all %}
              <tr>
                <td class="fw-semibold">{{ a.name|default:"Account" }} {% if a.mask %}<span class="text-muted">••{{ a.mask }}</span>{% endif %}</td>
                <td class="text-muted small">{{ a.type }}{% if a.subtype %} / {{ a.subtype }}{% endif %}</td>
                <td class="text-end text-muted small">{{ a.currency }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="text-secondary small py-3">No accounts imported yet. Try syncing.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <hr>

      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
          <div class="fw-semibold">Rules</div>
          <div class="small text-secondary">Suggest categories, ignore noise, and mark transfers.</div>
        </div>
        <div class="d-flex gap-2">
          <form method="post" action="{% url 'integrations:banking_apply_rules' %}">
            {% csrf_token %}
            <button class="btn btn-outline-primary" type="submit">
              <i class="bi bi-magic me-1"></i>Apply rules
            </button>
          </form>
          <a class="btn btn-outline-secondary" href="{% url 'integrations:banking_rules' %}">
            Manage rules
          </a>
        </div>
      </div>

      {% if rules %}
        <div class="small text-secondary mt-2">Top rules (showing up to 50):</div>
        <div class="mt-2">
          {% for r in rules %}
            <span class="badge rounded-pill text-bg-light border me-1 mb-1">
              #{{ r.priority }} · {{ r.get_action_display }} · {{ r.match_text }}
            </span>
          {% endfor %}
        </div>
      {% else %}
        <div class="small text-secondary mt-2">No rules yet. Create one for common merchants (e.g. Home Depot → Materials).</div>
      {% endif %}

      <hr>

      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
          <div class="fw-semibold">Review queue</div>
          <div class="small text-secondary">Process imported transactions and prevent duplicate expenses.</div>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-primary" href="{% url 'integrations:banking_review_queue' %}">
            <i class="bi bi-inbox me-1"></i>Open review queue
          </a>
          <a class="btn btn-outline-secondary" href="{% url 'integrations:banking_reconcile' %}">
            <i class="bi bi-clipboard-check me-1"></i>Reconcile
          </a>
        </div>
      </div>

      <hr>

      <div class="fw-semibold mb-2">Recent transactions</div>
      <div class="small text-secondary mb-2">Showing the most recent 50 imported transactions across all accounts.</div>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Date</th>
              <th>Merchant</th>
              <th>Status</th>
              <th class="text-muted">Category</th>
              <th class="text-muted">Suggested</th>
              <th class="text-end">Amount</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for tx in recent_txs %}
              <tr>
                <td class="text-muted small">{{ tx.posted_date|default:"" }}</td>
                <td class="fw-semibold">{{ tx.name }}</td>
                <td>
                  {% if tx.status == 'ignored' %}
                    <span class="badge text-bg-secondary">Ignored</span>
                  {% elif tx.status == 'transfer' %}
                    <span class="badge text-bg-warning">Transfer</span>
                  {% elif tx.status == 'expense_created' %}
                    <span class="badge text-bg-success">Expense</span>
                  {% else %}
                    <span class="badge text-bg-light border">New</span>
                  {% endif %}
                </td>
                <td class="text-muted small">{{ tx.category }}</td>
                <td class="text-muted small">
                  {% if tx.suggested_category %}<div>Cat: {{ tx.suggested_category }}</div>{% endif %}
                  {% if tx.suggested_merchant_name %}<div>Merch: {{ tx.suggested_merchant_name }}</div>{% endif %}
                  {% if tx.applied_rule %}<div class="small">Rule: #{{ tx.applied_rule.priority }}</div>{% endif %}
                </td>
                <td class="text-end">
                  <span class="{% if tx.amount_cents > 0 %}text-danger{% else %}text-success{% endif %}">
                    {{ tx.amount_cents|money }}
                  </span>
                </td>
                <td class="text-end">
                  <div class="d-flex justify-content-end gap-1 flex-wrap">
                    {% if tx.amount_cents > 0 %}
                      {% if tx.status == 'expense_created' and tx.linked_expense_id %}
                        <a class="btn btn-sm btn-outline-success" href="{% url 'expenses:expense_edit' tx.linked_expense_id %}">Open expense</a>
                      {% else %}
                        <form method="post" action="{% url 'integrations:banking_tx_create_expense' tx.id %}">
                          {% csrf_token %}
                          <button class="btn btn-sm btn-outline-secondary" type="submit" {% if tx.status == 'ignored' or tx.status == 'transfer' %}disabled{% endif %}>
                            Create expense
                          </button>
                        </form>
                      {% endif %}

                      <form method="post" action="{% url 'integrations:banking_tx_mark' tx.id 'ignored' %}">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-outline-secondary" type="submit">Ignore</button>
                      </form>
                      <form method="post" action="{% url 'integrations:banking_tx_mark' tx.id 'transfer' %}">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-outline-secondary" type="submit">Transfer</button>
                      </form>
                    {% else %}
                      <span class="text-muted small">Income</span>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="7" class="text-secondary small py-3">No transactions imported yet. Click “Sync transactions”.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif %}

</div>
</div>
{% endblock %}
