{% extends "base_app.html" %}

{% block title %}{% if mode == 'edit' %}Edit Expense{% else %}New Expense{% endif %} · EZ360PM{% endblock %}

{% block content %}
<div class="mb-3">
  <a class="btn btn-outline-dark btn-sm" href="{% url 'expenses:expense_list' %}">
    <i class="bi bi-arrow-left me-1"></i>Back
  </a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <h1 class="h5 mb-3">{% if mode == 'edit' %}Edit Expense{% else %}New Expense{% endif %}</h1>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Merchant</label>
          {{ form.merchant }}
          {% if form.merchant.errors %}<div class="text-danger small">{{ form.merchant.errors }}</div>{% endif %}
          <div class="mt-2">
            <label class="form-label small text-secondary">Or create new merchant</label>
            {{ form.new_merchant_name }}
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Vendor (optional)</label>
          {{ form.vendor }}
        </div>

        <div class="col-md-4">
          <label class="form-label">Date</label>
          {{ form.date }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Category</label>
          {{ form.category }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Status</label>
          {{ form.status }}
        </div>

        <div class="col-md-6">
          <label class="form-label">Client (optional)</label>
          {{ form.client }}
        </div>
        <div class="col-md-6">
          <label class="form-label">Project (optional)</label>
          {{ form.project }}
        </div>

        <div class="col-12">
          <label class="form-label">Description</label>
          {{ form.description }}
        </div>

        <div class="col-md-6">
          <label class="form-label">Receipt (optional)</label>
          {{ form.receipt }}
          {{ form.receipt_s3_key }}
          {% if mode == 'edit' and expense.receipt %}
            <div class="mt-2">
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'expenses:expense_receipt_open' expense.id %}" target="_blank" rel="noopener">
                <i class="bi bi-paperclip me-1"></i>Open current receipt
              </a>
            </div>
          {% endif %}
          <div id="receiptUploadStatus" class="text-secondary small mt-2" style="display:none;"></div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Amount</label>
          {{ form.amount_dollars }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Tax</label>
          {{ form.tax_dollars }}
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-4">
        <a class="btn btn-outline-secondary" href="{% url 'expenses:expense_list' %}">Cancel</a>
        <button id="expenseSubmitBtn" class="btn btn-dark" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

{% if use_s3 %}
<script>
(function() {
  const form = document.querySelector('form');
  if (!form) return;

  const fileInput = form.querySelector('input[type="file"][name="receipt"]');
  const keyInput = form.querySelector('input[name="receipt_s3_key"]');
  const statusEl = document.getElementById('receiptUploadStatus');
  const submitBtn = document.getElementById('expenseSubmitBtn');

  if (!fileInput || !keyInput || !submitBtn) return;

  async function presign(file) {
    const res = await fetch('{% url "core:presign_private_upload" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': (form.querySelector('input[name="csrfmiddlewaretoken"]') || {}).value || ''
      },
      body: JSON.stringify({
        kind: 'expense_receipt',
        filename: file.name,
        content_type: file.type || 'application/octet-stream'
      })
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'Presign failed');
    return data;
  }

  async function uploadToS3(file, presigned) {
    const fd = new FormData();
    Object.entries(presigned.fields || {}).forEach(([k, v]) => fd.append(k, v));
    fd.append('file', file);

    const res = await fetch(presigned.url, { method: 'POST', body: fd });
    if (!res.ok) throw new Error('Upload failed');
    return true;
  }

  form.addEventListener('submit', async function(ev) {
    // If no file chosen, normal submit.
    if (!fileInput.files || !fileInput.files.length) return;

    // If we've already uploaded (key present), normal submit.
    if ((keyInput.value || '').trim()) return;

    ev.preventDefault();
    submitBtn.disabled = true;
    statusEl.style.display = 'block';
    statusEl.textContent = 'Uploading receipt…';

    try {
      const file = fileInput.files[0];
      const presigned = await presign(file);
      await uploadToS3(file, presigned);
      keyInput.value = presigned.object_name;
      statusEl.textContent = 'Upload complete. Saving…';
      form.submit();
    } catch (e) {
      console.error(e);
      statusEl.textContent = 'Upload failed: ' + (e && e.message ? e.message : 'Unknown error');
      submitBtn.disabled = false;
    }
  });
})();
</script>
{% endif %}
{% endblock %}
