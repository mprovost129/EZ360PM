{% extends "base_app.html" %}

{% block app_content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-0">Ops Checks</h1>
    <div class="text-muted small">Run ops-grade checks (staff-only). Output is captured for copy/paste into launch evidence.</div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="post" class="row g-3">
      {% csrf_token %}

      <div class="col-md-4">
        <label class="form-label">Company (optional)</label>
        {{ form.company }}
        {% if form.company.help_text %}
          <div class="form-text">{{ form.company.help_text }}</div>
        {% endif %}
      </div>

      <div class="col-md-8">
        <label class="form-label">Checks</label>
        <div class="d-flex flex-wrap gap-4">
          <div class="form-check">
            {{ form.run_smoke }}
            <label class="form-check-label">Smoke Test</label>
          </div>
          <div class="form-check">
            {{ form.run_all }}
            <label class="form-check-label">Run all</label>
            {% if form.run_all.help_text %}
              <div class="form-text">{{ form.run_all.help_text }}</div>
            {% endif %}
          </div>
          <div class="form-check">
            {{ form.run_invariants }}
            <label class="form-check-label">Invariants</label>
          </div>
          <div class="form-check">
            {{ form.run_idempotency }}
            <label class="form-check-label">Idempotency Scan</label>
          </div>
          <div class="form-check mt-1">
            {{ form.run_template_sanity }}
            <label class="form-check-label" for="{{ form.run_template_sanity.id_for_label }}">Template sanity</label>
          </div>
          <div class="form-check mt-1">
            {{ form.run_url_sanity }}
            <label class="form-check-label" for="{{ form.run_url_sanity.id_for_label }}">URL sanity</label>
          </div>
          <div class="form-check">
            {{ form.run_readiness }}
            <label class="form-check-label">Readiness Check</label>
          </div>
        </div>
      </div>

      
      <div class="col-12">
        <label class="form-label">Options</label>
        <div class="d-flex flex-wrap gap-4">
          <div class="form-check">
            {{ form.fail_fast }}
            <label class="form-check-label">Fail fast</label>
          </div>
          <div class="form-check">
            {{ form.quiet }}
            <label class="form-check-label">Quiet</label>
          </div>
        </div>
        <div class="form-text">Options apply where supported (invariants/idempotency). Smoke test always prints full output.</div>
      </div>

      <div class="col-12">
        <button class="btn btn-dark" type="submit">
          <i class="bi bi-play-fill me-1"></i>Run checks
        </button>
      </div>
    </form>
  </div>
</div>

{% if output %}
  {% for title, text in output.items %}
    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div class="fw-semibold">{{ title }}</div>
      </div>
      <div class="card-body">
        <pre class="small mb-0" style="white-space: pre-wrap;">{{ text }}</pre>
      </div>
    </div>
  {% endfor %}
{% endif %}


<hr class="my-4"/>

<div class="d-flex align-items-center justify-content-between mb-2">
  <h2 class="h6 mb-0">Recent Runs</h2>
  <a class="btn btn-sm btn-outline-dark" href="{% url 'ops:check_runs_export' %}?days=7&limit=200">
    <i class="bi bi-download me-1"></i>Export (7d)
  </a>
</div>
<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0">
        <thead>
          <tr>
            <th>When</th>
            <th>Kind</th>
            <th>Company</th>
            <th>OK</th>
            <th>Duration</th>
            <th>Run by</th>
            <th>Output</th>
          </tr>
        </thead>
        <tbody>
          {% for r in recent_runs %}
            <tr>
              <td class="text-muted small">{{ r.created_at|date:"Y-m-d H:i" }}</td>
              <td>{{ r.get_kind_display }}</td>
              <td>{% if r.company %}{{ r.company.name }} ({{ r.company_id }}){% else %}-{% endif %}</td>
              <td>
                {% if r.is_ok %}
                  <span class="badge text-bg-success">OK</span>
                {% else %}
                  <span class="badge text-bg-danger">FAIL</span>
                {% endif %}
              </td>
              <td class="text-muted small">{{ r.duration_ms }} ms</td>
              <td class="text-muted small">{{ r.created_by_email|default:"-" }}</td>
              <td>
                <details>
                  <summary class="small">view</summary>
                  <div class="mt-1">
                    <a class="small" href="{% url 'ops:check_run_download' r.id %}">download</a>
                  </div>
                  <pre class="small mb-0" style="white-space: pre-wrap;">{{ r.output_text }}</pre>
                </details>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="7" class="text-muted small p-3">No runs yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>


{% endblock %}
