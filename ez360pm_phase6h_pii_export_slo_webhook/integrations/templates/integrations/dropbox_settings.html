{% extends "base_app.html" %}
{% block title %}Dropbox · EZ360PM{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <div>
    <h1 class="h4 mb-1">Dropbox integration</h1>
    <div class="text-secondary small">Connect Dropbox to prepare for file sync and storage integrations.</div>
  </div>
  <a class="btn btn-outline-secondary" href="{% url 'companies:settings' %}">
    <i class="bi bi-gear me-1"></i>Company settings
  </a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <div class="mb-3">
      <div class="small text-secondary">Active company</div>
      <div class="fw-semibold">{{ company.name }}</div>
    </div>

    {% if not dropbox_configured %}
      <div class="alert alert-warning mb-3">
        Dropbox is not configured yet. Add <code>DROPBOX_APP_KEY</code> and <code>DROPBOX_APP_SECRET</code> to your environment.
      </div>
    {% endif %}

    {% if conn and conn.is_active %}
      <div class="alert alert-success d-flex align-items-start justify-content-between gap-3">
        <div>
          <div class="fw-semibold mb-1"><i class="bi bi-check-circle me-1"></i>Connected</div>
          <div class="small text-secondary">
            Account ID: <code>{{ conn.account_id|default:"(unknown)" }}</code><br>
            Scope: <code>{{ conn.scope|default:"(not provided)" }}</code>
            {% if conn.expires_at %}<br>Token expires: {{ conn.expires_at }}{% endif %}
          </div>
          <div class="small text-secondary mt-2">
            Note: tokens are stored in the database. We can add encryption-at-rest in a later pack.
          </div>
        </div>

        <form method="post" action="{% url 'integrations:dropbox_disconnect' %}">
          {% csrf_token %}
          <button class="btn btn-outline-danger" type="submit">
            <i class="bi bi-x-circle me-1"></i>Disconnect
          </button>
        </form>
      </div>
    {% else %}
      <p class="text-secondary mb-3">
        Not connected yet. Connect Dropbox to enable future features like saving project files to Dropbox, syncing attachments, and sharing folders.
      </p>
      <a class="btn btn-dark {% if not dropbox_configured %}disabled{% endif %}" href="{% url 'integrations:dropbox_connect' %}">
        <i class="bi bi-box-arrow-in-right me-1"></i>Connect Dropbox
      </a>
    {% endif %}

    <hr>

    <div class="mt-4">
      <h2 class="h6 mb-2">Preferences</h2>
      <form method="post" class="border rounded p-3 bg-light">
        {% csrf_token %}
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="use_dropbox_for_project_files" id="use_dropbox_for_project_files"
                 {% if cfg.use_dropbox_for_project_files %}checked{% endif %}
                 {% if not conn or not conn.is_active %}disabled{% endif %}>
          <label class="form-check-label" for="use_dropbox_for_project_files">
            Upload new Project Files to Dropbox automatically
          </label>
          <div class="text-secondary small mt-1">
            When enabled, files uploaded on the Project Files page will be saved locally and also uploaded to Dropbox (with a shareable link).
            {% if not conn or not conn.is_active %}
              Connect Dropbox to enable this option.
            {% endif %}
          </div>
        </div>
        <div class="mt-3">
          <button class="btn btn-dark" type="submit">
            <i class="bi bi-save me-1"></i>Save preferences
          </button>
        </div>
      </form>
    </div>


    <div class="small text-secondary">
      <div class="fw-semibold text-dark mb-1">What this enables (next packs)</div>
      <ul class="mb-0">
        <li>Optional Dropbox-backed storage for Project Files</li>
        <li>“Export project folder to Dropbox” button</li>
        <li>Desktop sync agent can mirror files automatically</li>
      </ul>
    </div>
  </div>
</div>
{% endblock %}
