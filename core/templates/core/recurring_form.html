{% extends "_app_shell.html" %}
{% block page_title %}{% if form.instance.pk %}Edit Recurring Plan{% else %}New Recurring Plan{% endif %}{% endblock %}
{% block app_content %}

<div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">{% if form.instance.pk %}Edit Plan{% else %}Create Plan{% endif %}</h5>
  {% if form.instance.pk %}
    <div class="d-flex gap-2">
      <form method="post" action="{% url 'core:recurring_run_now' form.instance.pk %}" class="d-inline">
        {% csrf_token %}
        <button class="btn btn-sm btn-outline-primary"
                {% if form.instance.status != 'active' %}disabled title="Plan is paused"{% endif %}>
          Run now
        </button>
      </form>
      <form method="post" action="{% url 'core:recurring_toggle' form.instance.pk %}" class="d-inline">
        {% csrf_token %}
        {% if form.instance.status == 'active' %}
          <button class="btn btn-sm btn-outline-warning">Pause</button>
        {% else %}
          <button class="btn btn-sm btn-outline-success">Activate</button>
        {% endif %}
      </form>
      <form method="post" action="{% url 'core:recurring_delete' form.instance.pk %}"
            class="d-inline" onsubmit="return confirm('Delete this recurring plan? This cannot be undone.');">
        {% csrf_token %}
        <button class="btn btn-sm btn-outline-danger">Delete</button>
      </form>
    </div>
  {% endif %}
</div>

<div class="card shadow-sm">
  <div class="card-body">

    {# top-level (non-field) errors #}
    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        <ul class="mb-0">{% for err in form.non_field_errors %}<li>{{ err }}</li>{% endfor %}</ul>
      </div>
    {% endif %}

    <form method="post" class="row g-3">
      {% csrf_token %}

      <div class="col-12 col-md-6">
        <label class="form-label" for="{{ form.title.id_for_label }}">Title</label>
        {{ form.title }}
        {% if form.title.help_text %}<div class="form-text">{{ form.title.help_text }}</div>{% endif %}
        {% if form.title.errors %}<div class="invalid-feedback d-block">{% for e in form.title.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>{% endif %}
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label" for="{{ form.client.id_for_label }}">Client</label>
        {{ form.client }}
        {% if form.client.errors %}<div class="invalid-feedback d-block">{% for e in form.client.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>{% endif %}
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label" for="{{ form.project.id_for_label }}">Project (optional)</label>
        {{ form.project }}
        {% if form.project.errors %}<div class="invalid-feedback d-block">{% for e in form.project.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>{% endif %}
      </div>

      <div class="col-12 col-md-6">
        <label class="form-label" for="{{ form.template_invoice.id_for_label }}">Template Invoice (optional)</label>
        {{ form.template_invoice }}
        <div class="form-text">Items/notes/tax copied each cycle.</div>
        {% if form.template_invoice.errors %}<div class="invalid-feedback d-block">{% for e in form.template_invoice.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>{% endif %}
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label" for="{{ form.frequency.id_for_label }}">Frequency</label>
        {{ form.frequency }}
        {% if form.frequency.errors %}<div class="invalid-feedback d-block">{% for e in form.frequency.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>{% endif %}
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label" for="{{ form.start_date.id_for_label }}">Start date</label>
        {{ form.start_date }}
        {% if form.start_date.errors %}<div class="invalid-feedback d-block">{% for e in form.start_date.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>{% endif %}
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label" for="{{ form.next_run_date.id_for_label }}">Next run date</label>
        {{ form.next_run_date }}
        <div class="form-text">First issue date shown below; preview updates as you change fields.</div>
        {% if form.next_run_date.errors %}<div class="invalid-feedback d-block">{% for e in form.next_run_date.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>{% endif %}
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label" for="{{ form.end_date.id_for_label }}">End date</label>
        {{ form.end_date }}
        {% if form.end_date.errors %}<div class="invalid-feedback d-block">{% for e in form.end_date.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>{% endif %}
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label" for="{{ form.due_days.id_for_label }}">Due days</label>
        {{ form.due_days }}
        <div class="form-text">Days after issue date for due date.</div>
        {% if form.due_days.errors %}<div class="invalid-feedback d-block">{% for e in form.due_days.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>{% endif %}
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label" for="{{ form.status.id_for_label }}">Status</label>
        {{ form.status }}
        {% if form.status.errors %}<div class="invalid-feedback d-block">{% for e in form.status.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>{% endif %}
      </div>

      <div class="col-12 col-md-4">
        <div class="form-check mt-4">
          {{ form.auto_email }} <label class="form-check-label" for="{{ form.auto_email.id_for_label }}">Auto email invoice</label>
          {% if form.auto_email.errors %}<div class="invalid-feedback d-block">{% for e in form.auto_email.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>{% endif %}
        </div>
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label" for="{{ form.max_occurrences.id_for_label }}">Max occurrences</label>
        {{ form.max_occurrences }}
        <div class="form-text">Stop after N issues (optional).</div>
        {% if form.max_occurrences.errors %}<div class="invalid-feedback d-block">{% for e in form.max_occurrences.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>{% endif %}
      </div>

      <div class="col-12">
        <div class="text-muted small">Upcoming issues (preview): <span id="schedPreview">—</span></div>
      </div>

      <div class="col-12 d-flex gap-2 mt-2">
        <button class="btn btn-primary">Save</button>
        <a class="btn btn-outline-secondary" href="{% url 'core:recurring_list' %}">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
(function() {
  function addMonthsClamp(dateStr, m) {
    const d = new Date(dateStr);
    if (isNaN(d)) return null;
    const day = d.getDate();
    const target = new Date(d);
    target.setMonth(target.getMonth() + m);
    if (target.getDate() !== day) { target.setDate(0); } // clamp to end-of-month
    return target;
  }
  function advanceDates(startStr, freq, n) {
    const out = [];
    let cur = new Date(startStr);
    if (isNaN(cur)) return out;
    for (let i = 0; i < n; i++) {
      out.push(cur.toISOString().slice(0,10));
      if (freq === 'weekly') {
        cur = new Date(cur.getTime() + 7 * 86400000);
      } else if (freq === 'monthly') {
        cur = addMonthsClamp(cur.toISOString().slice(0,10), 1);
      } else if (freq === 'quarterly') {
        cur = addMonthsClamp(cur.toISOString().slice(0,10), 3);
      } else if (freq === 'yearly') {
        cur = addMonthsClamp(cur.toISOString().slice(0,10), 12);
      }
    }
    return out;
  }
  function $(id) { return document.getElementById(id); }
  function refreshPreview() {
    const freqEl = $('{{ form.frequency.id_for_label }}');
    const nextEl = $('{{ form.next_run_date.id_for_label }}');
    const startEl = $('{{ form.start_date.id_for_label }}');
    const freq = freqEl ? freqEl.value : 'monthly';
    const start = (nextEl && nextEl.value) ? nextEl.value : (startEl ? startEl.value : '');
    const span = document.getElementById('schedPreview');
    if (!start) { span.textContent = '—'; return; }
    const dates = advanceDates(start, freq, 3);
    span.textContent = dates.length ? dates.join(', ') : '—';
  }
  document.addEventListener('change', refreshPreview, true);
  document.addEventListener('DOMContentLoaded', function() {
    const startEl = $('{{ form.start_date.id_for_label }}');
    const nextEl  = $('{{ form.next_run_date.id_for_label }}');
    if (startEl && nextEl) {
      startEl.addEventListener('change', function() {
        if (!nextEl.value) nextEl.value = startEl.value; // default next_run to start date if empty
        refreshPreview();
      });
    }
    refreshPreview();
  });
})();
</script>

{% endblock %}
