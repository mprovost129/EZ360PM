{% extends "_app_shell.html" %}
{% block page_title %}Invoices{% endblock %}

{% block app_content %}
<div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
  <form class="d-flex" method="get" role="search" style="max-width:520px; width:100%">
    <label for="invoiceSearch" class="visually-hidden">Search invoices</label>
    <input id="invoiceSearch" class="form-control" type="search" name="q" value="{{ q }}" placeholder="Search by number, client, project…">

    <label for="invoiceStatus" class="visually-hidden">Filter by status</label>
    <select id="invoiceStatus" class="form-select ms-2" name="status" onchange="this.form.submit()" style="max-width:180px">
      <option value="" {% if not status %}selected{% endif %}>All statuses</option>
      <option value="draft" {% if status == 'draft' %}selected{% endif %}>Draft</option>
      <option value="sent" {% if status == 'sent' %}selected{% endif %}>Sent</option>
      <option value="paid" {% if status == 'paid' %}selected{% endif %}>Paid</option>
      <option value="void" {% if status == 'void' %}selected{% endif %}>Void</option>
    </select>

    {% if q or status %}
      <a class="btn btn-outline-secondary ms-2" href="{% url 'core:invoices' %}">Clear</a>
    {% endif %}
  </form>

  <a class="btn btn-primary" href="{% url 'core:invoice_create' %}">New Invoice</a>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th style="min-width:120px">#</th>
          <th>Client</th>
          <th>Project</th>
          <th>Issued</th>
          <th>Due</th>
          <th>Status</th>
          <th class="text-end">Total</th>
          <th class="text-end">Balance</th>
          <th class="text-end" style="width:160px"></th>
        </tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
        <tr>
          <td><a href="{% url 'core:invoice_detail' inv.pk %}">{{ inv.number }}</a></td>
          <td>{{ inv.client }}</td>
          <td>{{ inv.project|default:"—" }}</td>
          <td>{{ inv.issue_date|date:'Y-m-d' }}</td>
          <td>{{ inv.due_date|date:'Y-m-d'|default:"—" }}</td>
          <td class="text-capitalize">
            {% with s=inv.status %}
              <span class="badge
                {% if s == 'paid' %} text-bg-success
                {% elif s == 'sent' %} text-bg-info
                {% elif s == 'draft' %} text-bg-secondary
                {% elif s == 'void' %} text-bg-dark
                {% else %} text-bg-light
                {% endif %}">
                {{ s }}
              </span>
            {% endwith %}
          </td>
          <td class="text-end">${{ inv.total|floatformat:2 }}</td>
          <td class="text-end">${{ inv.balance|floatformat:2 }}</td>
          <td class="text-end">
            <div class="btn-group btn-group-sm" role="group" aria-label="Invoice actions">
              <a class="btn btn-outline-secondary" href="{% url 'core:invoice_update' inv.pk %}">Edit</a>
              <a class="btn btn-outline-danger" href="{% url 'core:invoice_delete' inv.pk %}">Delete</a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="text-center text-muted py-5">
            <div class="mb-2">No invoices yet.</div>
            <a class="btn btn-primary btn-sm" href="{% url 'core:invoice_create' %}">Create your first invoice</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card-body d-flex justify-content-between align-items-center">
    <div class="text-muted small">
      {% if q or status %}
        Showing filtered results{% if q %} for “{{ q }}”{% endif %}{% if status %} (status: {{ status }}){% endif %}.
      {% else %}
        All invoices.
      {% endif %}
    </div>
    <div class="text-muted">
      Outstanding: <strong>${{ outstanding|floatformat:2 }}</strong>
    </div>
  </div>

  {# Optional pagination block; harmless if page_obj isn't provided #}
  {% if page_obj and page_obj.has_other_pages %}
    <div class="card-footer d-flex justify-content-between align-items-center">
      <span class="small text-muted">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      <nav aria-label="Invoices pagination">
        <ul class="pagination pagination-sm mb-0">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status }}{% endif %}">Prev</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Prev</span></li>
          {% endif %}

          {% for p in page_obj.paginator.page_range %}
            {% if p == page_obj.number %}
              <li class="page-item active" aria-current="page"><span class="page-link">{{ p }}</span></li>
            {% elif p >= page_obj.number|add:'-2' and p <= page_obj.number|add:'2' %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ p }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status }}{% endif %}">{{ p }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q|urlencode }}{% endif %}{% if status %}&status={{ status }}{% endif %}">Next</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  {% endif %}
</div>
{% endblock %}
