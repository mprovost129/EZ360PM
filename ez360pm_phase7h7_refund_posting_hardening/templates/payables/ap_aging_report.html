{% extends "base_app.html" %}
{% load formatting %}
{% block title %}A/P Aging · EZ360PM{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h4 mb-1">A/P Aging</h1>
    <div class="text-secondary small">Open bills bucketed by days past due. As of {{ today }}.</div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'payables:bill_list' %}"><i class="bi bi-receipt me-1"></i>Bills</a>
    <a class="btn btn-outline-secondary" href="{% url 'payables:ap_aging_report_csv' %}"><i class="bi bi-download me-1"></i>CSV</a>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-2">
    <div class="card shadow-sm"><div class="card-body">
      <div class="text-secondary small">Current</div>
      <div class="h5 mb-0">{{ totals.current|cents_to_dollars }}</div>
    </div></div>
  </div>
  <div class="col-md-2">
    <div class="card shadow-sm"><div class="card-body">
      <div class="text-secondary small">1–30</div>
      <div class="h5 mb-0">{{ totals.d1_30|cents_to_dollars }}</div>
    </div></div>
  </div>
  <div class="col-md-2">
    <div class="card shadow-sm"><div class="card-body">
      <div class="text-secondary small">31–60</div>
      <div class="h5 mb-0">{{ totals.d31_60|cents_to_dollars }}</div>
    </div></div>
  </div>
  <div class="col-md-2">
    <div class="card shadow-sm"><div class="card-body">
      <div class="text-secondary small">61–90</div>
      <div class="h5 mb-0">{{ totals.d61_90|cents_to_dollars }}</div>
    </div></div>
  </div>
  <div class="col-md-2">
    <div class="card shadow-sm"><div class="card-body">
      <div class="text-secondary small">90+</div>
      <div class="h5 mb-0">{{ totals.d90p|cents_to_dollars }}</div>
    </div></div>
  </div>
  <div class="col-md-2">
    <div class="card shadow-sm"><div class="card-body">
      <div class="text-secondary small">Total</div>
      <div class="h5 mb-0">{{ totals.total|cents_to_dollars }}</div>
    </div></div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-striped mb-0">
      <thead>
        <tr>
          <th>Vendor</th>
          <th>Bill #</th>
          <th>Issue</th>
          <th>Due</th>
          <th class="text-end">Balance</th>
          <th class="text-end">Bucket</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr>
            <td class="fw-semibold">{{ r.vendor.name }}</td>
            <td>{{ r.bill.bill_number|default:"—" }}</td>
            <td>{{ r.bill.issue_date }}</td>
            <td>{{ r.bill.due_date|default:"—" }}</td>
            <td class="text-end">{{ r.balance_cents|cents_to_dollars }}</td>
            <td class="text-end">
              {% if r.bucket == 'current' %}<span class="badge text-bg-secondary">Current</span>{% endif %}
              {% if r.bucket == 'd1_30' %}<span class="badge text-bg-warning">1–30</span>{% endif %}
              {% if r.bucket == 'd31_60' %}<span class="badge text-bg-warning">31–60</span>{% endif %}
              {% if r.bucket == 'd61_90' %}<span class="badge text-bg-danger">61–90</span>{% endif %}
              {% if r.bucket == 'd90p' %}<span class="badge text-bg-danger">90+</span>{% endif %}
            </td>
            <td class="text-end"><a class="btn btn-sm btn-outline-secondary" href="{% url 'payables:bill_detail' r.bill.id %}">Open</a></td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="text-center text-secondary py-4">No open bills.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
