{% extends "base_app.html" %}
{% load formatting %}
{% block title %}Ops · Drift Toolkit · EZ360PM{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1200px;">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1">Reconciliation Drift Toolkit</h1>
      <div class="text-secondary small">Staff-only tools to detect and fix common “money loop” drift.</div>
    </div>

    <form method="get" class="d-flex gap-2">
      <select name="company" class="form-select" style="min-width: 280px;">
        <option value="">Select company…</option>
        {% for c in companies %}
          <option value="{{ c.id }}" {% if company and c.id == company.id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-outline-dark" type="submit">Load</button>
    </form>
  </div>

  {% if not company %}
    <div class="alert alert-info">Select a company to view drift tools.</div>
  {% else %}
    <div class="row g-3">

      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h6 mb-2">One-click fixes</h2>
            <div class="text-secondary small mb-3">These actions are idempotent and safe to re-run.</div>

            <form method="post" action="{% url 'ops:drift_recalc' %}" class="mb-2">
              {% csrf_token %}
              {{ action_form.company_id }}
              <button class="btn btn-outline-primary w-100" type="submit">
                Recalculate invoice rollups (paid/balance/status)
              </button>
            </form>

            <form method="post" action="{% url 'ops:drift_post_missing' %}">
              {% csrf_token %}
              {{ action_form.company_id }}
              <button class="btn btn-outline-primary w-100" type="submit">
                Post missing accounting entries (invoices/payments/expenses)
              </button>
            </form>

            <div class="text-secondary small mt-3">
              Tip: if you see a flag in <a href="{% url 'ops:reconciliation' %}?company={{ company.id }}">Reconciliation</a>,
              run these first.
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h6 mb-2">Link an orphan payment to an invoice</h2>
            <div class="text-secondary small mb-3">Use when Stripe succeeded but the Payment row didn’t link to an invoice.</div>

            <form method="post" action="{% url 'ops:drift_link_payment' %}">
              {% csrf_token %}
              {{ link_form.company_id }}
              <div class="mb-2">
                <label class="form-label small">Payment UUID</label>
                {{ link_form.payment_id }}
              </div>
              <div class="mb-2">
                <label class="form-label small">Invoice UUID</label>
                {{ link_form.invoice_id }}
              </div>
              <button class="btn btn-primary w-100" type="submit">Link payment → invoice</button>
            </form>

            <div class="text-secondary small mt-3">
              After linking, the invoice rollups are recalculated and the payment is posted to accounting if needed.
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h6 mb-2">Orphan payments (succeeded/refunded, no invoice)</h2>
            {% if orphan_payments %}
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>When</th>
                      <th>Amount</th>
                      <th>Status</th>
                      <th>Client</th>
                      <th>Stripe PI</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for p in orphan_payments %}
                      <tr>
                        <td class="small">{{ p.created_at|date:"Y-m-d H:i" }}</td>
                        <td class="small">{{ p.amount_cents|cents_to_dollars }}</td>
                        <td class="small">{{ p.status }}</td>
                        <td class="small">{{ p.client|default:"—" }}</td>
                        <td class="small text-truncate" style="max-width: 180px;">{{ p.stripe_payment_intent_id|default:"—" }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-secondary small">No orphan payments detected.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h6 mb-2">Invoices likely needing a recalculation</h2>
            {% if invoice_candidates %}
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Invoice</th>
                      <th>Status</th>
                      <th>Total</th>
                      <th>Paid</th>
                      <th>Balance</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for inv in invoice_candidates %}
                      <tr>
                        <td class="small">{{ inv.number|default:inv.id }}</td>
                        <td class="small">{{ inv.status }}</td>
                        <td class="small">{{ inv.total_cents|cents_to_dollars }}</td>
                        <td class="small">{{ inv.amount_paid_cents|cents_to_dollars }}</td>
                        <td class="small">{{ inv.balance_due_cents|cents_to_dollars }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-secondary small">No obvious candidates in the last 50 invoices.</div>
            {% endif %}
            <div class="text-secondary small mt-2">
              This list is heuristic (fast). The “Recalculate invoice rollups” action is the authoritative fix.
            </div>
          </div>
        </div>
      </div>

    </div>
  {% endif %}
</div>
{% endblock %}
